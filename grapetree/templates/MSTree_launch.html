<!DOCTYPE html>
<html>


<head>
        <link rel="stylesheet" href='js/jquery-ui-1.11.4/jquery-ui.min.css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style>
                body{
                        width:100%;
                        height:100%;
                }

                #graph-div{
                        position: absolute;
                        top:10px;
                        left:180px;
                }

                #sidebar {
                        position:absolute;
                        top:10px;
                        width:180px;
                        margin-left:5px;
                }
                .brush.extent {
									stroke: #fff;
									fill-opacity: .125;
									shape-rendering: crispEdges;
                              }
                .selected{
                        background-color:blue;
                }


                .graph-selection-indicator {
                  position: absolute;
                  background: transparent;
                  border: 1px solid orange;
                }
                 .slider-class{
                        float: left;
                        clear: left;
                        width: 120px;
                        height:5px;
                        margin: 5px;
                }
                .slider-class .ui-slider-handle {
                        height:12px;
                }

                .mst-menu-title {

                        cursor:pointer;

                }
                .panel-body label{
                        margin-bottom:1px;
                        margin-top:4px;

                }
                .zoom-icon{
                        cursor:pointer;
                        font-size:22px;

                }
                .upload-download-icon{
                        cursor:pointer;
                        font-size:22px;

                }
                .add-data-icon{
                        cursor:pointer;
                        float:right;
                }
                .mst-menu-title span{
                        display:block;
                        float:right;
                }
                .panel-default{
                        margin-bottom:2px;
                }
                div.tooltip {
                        position: absolute;
                        text-align: center;
                        height: 28px;
                        padding: 2px;
                        font: 16px sans-serif;
                        background: lightsteelblue;
                        border: 0px;
                        border-radius: 8px;
                        pointer-events: none;
                }

                 #welcome-div {
                position: fixed;
                 top: 50%;
                 left: 50%;
                 transform: translate(-50%, -50%);
                 height:400px;
                 width:600px;
                 #border-style:solid;

                }


        </style>
</head>
<body>
<!--metadata div-->
<link rel="stylesheet" href="js/SlickGrid/slick.grid.css" type="text/css"/>
<link rel="stylesheet" href="js/SlickGrid/examples/examples.css" type="text/css"/>
<style>
.cell-title {
  font-weight: bold;
}
.cell-effort-driven {
  text-align: center;
}
.slick-header-column.ui-state-default {
	height: 24px
}
.ui-dialog-titlebar {
    background: #b0f2f2;
    border: 0;
    color: #fff;
    font-weight: normal;
}
.slick-row.odd {
	background: #ffffcc;
}
.slick-row.even {
	background: #ccffcc;
}

</style>
<div id = 'metadata-div' style='width:600px;height:600px;position:absolute;top:10%;left:50%;z-index:2;background-color:#f1f1f1;display:none'>
	<div id='handler' style="background-color:#f1f1f1;width:100%;height:20px;border-radius:5px;border: 0px solid #b0f2f2;">
		<span title='Close The Window' id = 'metadata-close' class='glyphicon glyphicon-remove show-tooltip'style='top:-6px;float:right;margin-right:10px'></span>
		<span title='Download This Table' id = 'metadata-download' class='glyphicon glyphicon-download show-tooltip'></span>&nbsp;&nbsp;
		<span title='Add A New Category' id="metadata-add-icon" class='glyphicon glyphicon-plus show-tooltip'></span>&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="checkBox" id="metadata-filter" checked><span title='Show Filtering Bar?' class='glyphicon glyphicon-filter show-tooltip'></span>&nbsp;&nbsp;&nbsp;&nbsp;
		<input type="checkBox" id="hypo-filter" ><span title='Show hypothetical nodes?' class='glyphicon glyphicon-screenshot show-tooltip'></span>
	</div>
	<div id="myGrid" style="width:100%;height:580px"></div>
	<div title='replace all the cells in the selection' id='replace-div' style='height:30px;width:30px;background-color:#ffffff;z-index:3;opacity:0.8'>
		<input id='replace-tag' style='height:100%;width:100%'>
		<span title='Confirm' id='replace-confirm' class='glyphicon glyphicon-ok show-tooltip' style='top:0px;left:100%;float:right;position:absolute'></span>
		<span title='Close' onclick='$("#replace-tag").val("");$("#replace-div").css("opacity",0.8).width(30).hide()' class='glyphicon glyphicon-remove show-tooltip' style='top:15px;left:100%;float:right;position:absolute'></span>
	</div>
</div>

<script src="js/SlickGrid/lib/firebugx.js"></script>

<script src="js/SlickGrid/lib/jquery-1.11.2.min.js"></script>
<script src="js/SlickGrid/lib/jquery-ui-1.11.3.min.js"></script>
<script src="js/SlickGrid/lib/jquery.event.drag-2.3.0.js"></script>

<script src="js/SlickGrid/slick.core.js"></script>
<script src="js/SlickGrid/plugins/slick.cellrangedecorator.js"></script>
<script src="js/SlickGrid/plugins/slick.cellrangeselector.js"></script>
<script src="js/SlickGrid/plugins/slick.cellselectionmodel.js"></script>
<script src="js/SlickGrid/slick.formatters.js"></script>
<script src="js/SlickGrid/slick.editors.js"></script>
<script src="js/SlickGrid/slick.grid.js"></script>
<script src="js/SlickGrid/slick.dataview.js"></script>
<script src="js/tree/grid.js"></script>

<!--information divs-->
<div id = 'welcome-div'>
<p align='center'><h2>
<b>G</b>rape <b>T</b>ree
</h2>
</p>
To get started Drag and drop files into the browser window
<h4>Trees or Profile Data</h4>
<ul>
<li><b>Phlogenetic trees</b> These can be nexus or nwk format and can have any file extension apart from
.txt,.csv,.profile and .json
</li>
<li>
<b>Profile Files (.profile)</b> These are tab delimited text with columns as alleles and strains as rows (see the examples).
This requires the local server to be running
</li>
<li><b>Custom Format(.json)</b> Files genereated by this program which contain
the tree data as well as display information and any metadata
</li>
</ul>
<h4>Metadata</h4>
<ul>
<li>
<b>Metadata files(.txt or.csv)</b> The file should have
one column 'ID' which corresponds to the node identifier in the tree. Multiple records can be linked to the
same node i.e have the same ID but then the file must have a coulmn 'Name' in which every entry is unique
</li>
</ul>
</div>


<div id ='information-div' class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content modal-sm">
      <div id ="modal-header" class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <p align='center'><img id ='waiting-image'style = 'display:none' src= 'js/img/ms_failed_1.png'></img></p>
	<span id = 'modal-title'></span>
      </div>
      <div class="modal-body">
        <p id ='waiting-information'></p>
	<div  id ='param-panel' style = 'display:none'>
		   <label>Method</label>
		   <div id='method-activate'></div>
		   <br>
		   <select id ='method-select'>
			   <option class='show-tooltip' title='MSTreeV2 uses a directed graph to handle missing data' value='MSTreeV2'>MSTreeV2</option>
			   <option class='show-tooltip' title='A traditional Minimum spanning tree + eBurst weighting' value='MSTree'>MSTree</option>
			   <option class='show-tooltip' title='FastME V2.0 is implemented for Neighbor-Joining phylogeny.' value='NJ'>Neighbour Joining</option>
		   </select>
		   <div id = "MST-option" style="display:none;">
		   <hr>
		   <label>Matrix Type</label>
		   <br>
		   <select id ='matrix-select'>
			   <option value='symmetric'>Symmetric</option>
			   <option value='asymmetric'>Asymmetric</option>
		   </select>
		   <div id = "symmetric-option">
		   <hr>
		   <label>Missing data</label>
		   <br>
		   <select id = 'missing-data'>
			   <option value='pair_delete'>ignore</option>
			   <option value='complete_delete'>ignore whole loci</option>
			   <option value='as_allele'>treated as an allele</option>
		   </select>
		   <hr>
		   </div>
		   <label>Edge Weight</label>
		   <br>
		   <select id = 'edge-weight-select'>
			   <option value='eBurst'>eBurst</option>
			   <option value='harmonic'>Harmonic</option>
		   </select>
		   <br>
		   <label>Neighboring Branch Reconnection (NBR)</label>
		   <br>
		   <select class='show-tooltip' title='NBR reconstructs paths in a spanning tree' id = 'branch-select'>
			   <option value='F'>False</option>
			   <option value='T'>True</option>
		   </select>
		   </div>
	   </div>
      </div>
      <div class="modal-footer">
        <button id ="modal-ok-button" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id='sidebar'>
	<div>
		<a class='show-tooltip' title="Databases of 100,000's of genomes" href="https://enterobase.warwick.ac.uk" target = '_blank'><img src="js/img/enterobase.png" alt="Enterobase" style="width:40px;height:45px;"></a>&nbsp;&nbsp;|&nbsp;&nbsp;
		<a class='show-tooltip' title='Github repository for this program' href="https://github.com/martinSergeant/EnteroMSTree" target = '_blank'><img src="js/img/GrapeTree.PNG" alt="GrapeTree" style="width:40px;height:50px;"></a>
		<h3 id="headertag" style="font-family: times, serif; font-size:12pt; font-style:italic">GrapeTree</h3>
	</div>
	<br>
	<div class='panel panel-default'>
		<div class ='panel-heading mst-menu-title' id= 'file-menu'> <b id>Inputs/Outputs</b><span id = 'file-menu-icon' class='glyphicon glyphicon-menu-down'> </span></div>
		<div class = "panel-body" id ='file-menu-panel'>
			<br>
				<button title='Load a tree or profile to start your journey!' id = 'button-load-nwk' class = 'show-tooltip'> Load Tree/Profile</button>
			<br><br>
				<button id = 'button-load-meta'> Load Metadata</button>
			<div id='save-panel'>
				<hr>
					<button id ="save-tree-json">Save GrapeTree</button><br><br>
					<button id ="save-tree-nwk">Save to Newick Tree</button><br><br>
					<button id ="mst-download-svg">Download SVG</button><br><br>
			</div>
		</div>
	</div>

	<div class='panel panel-default'>
		<div class ='panel-heading mst-menu-title' id= 'tree-menu'> <b id>Tree Layout</b><span id = 'tree-menu-icon' class='glyphicon glyphicon-menu-right'> </span></div>
		<div class = "panel-body" id ='tree-menu-panel'>
			<button id = 'button-goback' onclick='loadMSTree(tree_raw);if(current_metadata_file) {loadMetadataFile(current_metadata_file[0], current_metadata_file[1]);}'> Unmodified tree</button>
			<br><br>
			<div>
				<span onclick="$('#spinner-linklength').spinner('value', 100)" class='glyphicon glyphicon-refresh'></span><label>&nbsp;Branch Length (%)</label><br>
				<div id = "slider-linklength" class ="slider-class" style="width:60px">  </div><input type='text' style='width:39px;height:15px' id ='spinner-linklength' class='spin-group'>
			</div>
			
			<div class="show-tooltip" title="Collapse branches below a certain value">
				<span onclick="$('#spinner-collapse-nodes').spinner('value', 0)" class='glyphicon glyphicon-refresh'></span><label>&nbsp;Collapse Branches</label><br>
				<div id = "slider-collapse-nodes" class ="slider-class" style="width:60px"></div><input type='text' style='width:39px;height:15px' id ='spinner-collapse-nodes' class='spin-group'>
			</div>
			<label><input id ='link-log-scale'type="checkbox" />Log Scale</label>
			<br>
			<hr>
			<div >
				<span onclick="$('#spinner-nodesize').spinner('value', 100)" class='glyphicon glyphicon-refresh'></span><label>&nbsp;Node Size (%)</label><br>
				<div id = "slider-nodesize" class ="slider-class" style="width:60px"></div><input type='text' style='width:39px;height:15px' id ='spinner-nodesize' class='spin-group'>
			</div>
			
			<div class="show-tooltip" title="Node size relative to number of strains">
				<span onclick="$('#spinner-relative-nodesize').spinner('value', 100)" class='glyphicon glyphicon-refresh'></span><label>&nbsp;Node scaling (%)</label><br>
				<div id = "slider-relative-nodesize" class ="slider-class" style="width:60px"></div><input type='text' style='width:39px;height:15px' id ='spinner-relative-nodesize' class='spin-group'>
			</div>
			<br>
			<button id = 'button-refresh'> Static Redraw </button>
			<br><br>
			<button id ="center-graph-button">Centre Tree</button>
			<hr>
			<p align = 'center'>
				<label> Zoom:&nbsp;&nbsp;</label>
				<span onclick= "javascript:the_tree.setScale(1.1,true)" class=' zoom-icon glyphicon glyphicon-zoom-in'></span>
				<span onclick= "javascript:the_tree.setScale(0.9,true)"class='zoom-icon glyphicon glyphicon-zoom-out'></span>
			</p>
		</div>
	</div>
	<div class='panel panel-default'>
		<div class ='panel-heading mst-menu-title' id= 'mst-link-menu'> <b id>Branch Style</b><span id = 'mst-link-menu-icon' class='glyphicon glyphicon-menu-right'> </span></div>
		<div class = "panel-body" id ='mst-link-menu-panel'>
			<label>Hide Branchs Over:</label>
			<br>
			<input type='text' style='width:35px;height:15px' id ='spinner-hide-link-length' class='spin-group'>
			<button id ='button-hide-link-length'>Go</button>
			<br>
			<label>Max Branch Length:</label>
			<br>
			<input type='text' style='width:35px;height:15px' id ='spinner-maxlinklength' class='spin-group'>
			<button id ='button-setmaxlinklength'>Go</button>
			<br>
			<hr>
			<label><input id ='show-link-labels'type="checkbox" /> Branch Labels</label>
			<br>
			<label>Font Size:</label>
			<input type='text' style='width:20px;height:15px' id ='spinner-linkfontsize' class='spin-group'>
			<br>
			<div id = "slider-linkfontsize" class = "slider-class"></div>
			<br>
			<label><input id ='show-link-tooltip' type="checkbox" checked /> Mouseover info</label>
		</div>
	</div>
	<div class='panel panel-default'>
		<div class ='panel-heading mst-menu-title' id= 'mst-node-menu'> <b id>Nodes</b><span id = 'mst-node-menu-icon' class="glyphicon glyphicon-menu-right"></span></div>
		<div class = "panel-body" id ='mst-node-menu-panel'>
			<label>Colour By:</label>
			<br>
			<select style="width:140px" id= 'metadata-select'>
			<option value='nothing'>No category</option></select>

			<hr>
			<label><input id ='show-node-labels'type="checkbox" checked /> Node Labels</label>
			<br><br>
			<label>Font Size:</label><input type='text' style='width:20px;height:15px' id ='spinner-node-fontsize' class='spin-group'>
			<br>
			<div id = "slider-node-fontsize" class = "slider-class"></div>
			<label>Label Text</label>
			<select id = 'node-label-text'></select>
			<label>Search in Label</label>
			<br>
			<input size="11" id ='search-metadata-input'><span id ='search-metadata-icon' class='add-data-icon glyphicon glyphicon-search'></span>

			<br>
			<label><input id ='show-node-tooltip' type="checkbox" checked /> Mouseover info</label>
			<br>
			<label><input id ='show-individual-segments' type="checkbox" /> Seperate Strains</label>
		</div>
	</div>
	<div class='panel panel-default'>
		<div class ='panel-heading mst-menu-title' id= 'selection-menu'> <b id>Metadata</b><span id = 'selection-menu-icon' class='glyphicon glyphicon-menu-right'> </span></div>
		<div class = "panel-body" id ='selection-menu-panel'>
				<button id = 'button-editor' onclick="$('#metadata-div').show(300); setTimeout(function(){updateMetadataTable(true);}, 400);"> Metadata Window </button>
				<hr>
				<ul id="colList" style="width:100%"></ul>
		</div>
	</div>
	<div class='panel panel-default'>
		<div class ='panel-heading mst-menu-title' id= 'mst-layout-menu'> <b id>Rendering</b><span id = 'mst-layout-menu-icon' class="glyphicon glyphicon-menu-right"></span></div>
		<div class = "panel-body" id ='mst-layout-menu-panel'>
			<button onclick = 'javascript:the_tree.unfixSelectedNodes(! $("#render-selected-only").is(":checked"))' > Automatic</button>
			<label><input id ='render-selected-only' type="checkbox" /> Selected Only</label>
			<button id="stopAdjustment"> Static</button>
			<label><input id ='correct_link_length' type="checkbox" checked /> Real Branch Length</label>
		</div>
	</div>
	<div class='panel panel-default'>
		<div class ='panel-heading mst-menu-title' id= 'legend-menu'> <b id>Legend</b><span id = 'legend-menu-icon' class='glyphicon glyphicon-menu-right'> </span></div>
		<div class = "panel-body" id ='legend-menu-panel'>
		   <select id = 'Group order'>
				<label>Group Order: </label>
				<option value='alphabetic'>Alphabetic</option>
				<option value='numeric'>Numeric</option>
				<option value='no_strain'>No. of strains</option>
		   </select>
			<br><br>
				<button id = 'button-color-palette'> Color Palette </button>
			<br><br>
			<label>No. of Groups:</label><input type='text' style='width:20px;height:15px' id ='spinner-num-group' class='spin-group'>
			<br>
			<div id = "slider-num-group" class = "slider-class"></div>
			<br>
			<label>Font Size:</label><input type='text' style='width:20px;height:15px' id ='spinner-legend-fontsize' class='spin-group'>
			<br>
			<div id = "slider-legend-fontsize" class = "slider-class"></div>
		</div>
	</div>
</div>

<div id = "graph-div" class="graph-overlay"></div>

<script src ="js/jquery-ui-1.11.4/jquery-ui.min.js"></script>
<script src ="js/main/bootstrap.min.js"></script>
<script charset="utf-8" src="js/main/d3.min.js"></script>
<script charset="utf-8" src="js/main/spin.min.js"></script>
<script charset="utf-8" src="js/tree/base_tree.js"></script>
<script charset="utf-8" src="js/tree/d3_m_tree.js"></script>

<script>
     function showhide(id) {
       	var e = document.getElementById(id);
       	e.style.display = (e.style.display == 'block') ? 'none' : 'block';
     }

        MSFileChooser.prototype = Object.create(null);
        MSFileChooser.prototype.constructor= MSFileChooser;

        function MSFileChooser(filter){
                var self = this;
                this.fileInput = $("<input>").attr("type","file").css("display","none");
                this.callback=null;
                this.fileInput.attr("accept",filter);
                $('<body>').append(this.fileInput);
                this.fileInput.change(function(event){
                        self.callback(event.target.files);

                });

        }
        MSFileChooser.prototype.setFilter=function(filter){
                this.fileInput.attr("accept",filter);
        }
        MSFileChooser.prototype.showOpenDialog=function(callback){
                this.callback=callback;
                this.fileInput.trigger("click");
        }


        function MSCSCReader(file,delimiter,callback){
                var reader = new FileReader();
                reader.onload = function(progressEvent){
                        var return_data=[];
                        try{
                                var data =this.result;
                                var lines =  data.split(/\r\n|\r|\n/g);
                                var header = lines[0].split(delimiter);
                                var header_index={}
                                for (var i=0;i<header.length;i++){
                                        header_index[i]=header[i];

                                }

                                for (var i=1;i<lines.length;i++){
                                        var map = {};
                                         var arr = lines[i].split(delimiter);
                                         for (var col in arr){
                                                map[header_index[col]]=arr[col];
                                         }
                                         return_data.push(map);
                                }

                        }catch(error){
                                callback("Error",error.message)

                        }
                        callback("OK",return_data,header_index);
                };
                reader.readAsText(file);
        };

        function saveTextAsFile (text,suggested_name){
                var save = $("<a download><button>Save</button></a>").click(function(){
                        var name=$("#filename").val();
                        if(!name){
                            return;
                        }
                        //windows - don't actually use the file download anchor
                        if(window.navigator.msSaveOrOpenBlob) {
                            var data = new Blob([text], {type: 'text/plain'});
                            window.navigator.msSaveBlob(data,name);
                        }
                        //others
                        else{
                            var data = new Blob([text], {type: 'text/plain'});

                            this.textFile = window.URL.createObjectURL(data);
                            //set file name and contents before click event propogates
                            $(this).attr("download",name);
                            $(this).attr("href",this.textFile);

                        }
                        $(this).parent().dialog().dialog("close");
                });
				
				var notification = "<p style='font-size:10'> Some browsers allow you to select a folder after you click the 'Save' Button.<br><br> Whereas many browsers, such as Chrome, by default save the downloaded file into:<br><b>Windows</b>: <code>'&#92;Users&#92;&lt;username&gt;&#92;Downloads'</code><br><b>Mac</b>: <code>'/Users/&lt;username&gt;/Downloads'</code><br><b>Linux</b>: <code>'home/&lt;username&gt;/Downloads'</code><br><br></p>";
				var filenamebar = $("<input title='Suffix will be automatically added in some browsers if you have got a file with the same name.' type='text' id ='filename' value='"+suggested_name+"'>");
                //the actual dailog box
                $("<div id ='savedailog'></div>")
                .html(notification + "File Name: ")
                .dialog({
                    autoOpen: true,
                    modal: true,
                    title: "Save File",
                    buttons: {
                        "Cancel": function () {
                            $(this).dialog("close");
                        }
                    },
                    close: function () {
                        $(this).dialog('destroy').remove();
                    },
					width: "400px",
                }).append(filenamebar).append(save);
        };

	function getSuffix(name){
		var arr = name.split(".");
		return arr[arr.length-1];
	}

        var all_files=null;
	var metatdata_file_name;
        var waiting_spinner= null;
        var waitingDialog = null;
        var the_tree = null;
        var tree_name="";
	var cannot_connect=false;

	var default_control_panel_values={
		max_link_scale:500,
		base_node_size:10,
		max_link_length:"",
		size_power:0.5,
		log_link_scale:false,
		show_individual_segments:false,
		link_font_size:14,
		show_link_labels:false,
		show_node_labels:true,
		node_font_size:12,
		hide_link_length:"",
		node_collapsed_value:0
	};





        var tooltip_div =d3.select("body")
							.append("div")
							.attr("class", "tooltip")
							.style("opacity", 0)
							.style("z-index", 9)

        var legend_colour_chooser = $("<input>")
                                        .on("change",function(e){
                                                var cc  = $(this);
                                                the_tree.setColour(cc.data("category"),cc.data("value"),cc.val());
                                                the_tree.changeCategory(cc.data("category"));

                                        })
                                        .attr("type","color").hide();

        $("body").append(legend_colour_chooser);

        //a map of group to another map of name to label
        var metadata_options={};
        var new_metadata_fields=[];

        var locus_label ="";
        var file_chooser = new MSFileChooser(".nwk");
        var current_metadata_file = null;
	var all_files=null;
	var metadata_file_name = null;



        function downloadMetadata(){
                var lines= [];
                lines.push("Barcode\tName");
                for (var id in the_tree.metadata){
                        var item = the_tree.metadata[id];
                        var barcode = Enterobase.encodeBarcode(id,db_code);
                        lines.push(barcode+"\t"+item["Name"]);

                }
                var text= lines.join("\n");
                Enterobase.showSaveDialog(text,"tree.json");
        }

        function addMetadataOptions(value,label){
                if (!metadata_options[value]){
                        metadata_options[value]=label;
                        $("#metadata-select").append($("<option>").attr("value",value).text(label));
                        $("#node-label-text").append($("<option>").attr("value",value).text(label));
                        $("#add-new-values-select").append($("<option>").attr("value",value).text(label));

                }
        }
	function deleteMetadataCategory(){
		var category = $("#add-new-values-select").val();
		the_tree.removeCategory(category);
		$("#metadata-select option[value='"+category+"']").remove();
		$("#node-label-text option[value='"+category+"']").remove();
		$("#add-new-values-select option[value='"+category+"']").remove();
		delete metadata_options[category];
		updateMetadataTable();
	}


        function showToolTip(msg, e){
						if (!e) {e=d3.event;}
                        tooltip_div.transition()
							.duration(200)
							.style("opacity", .9);
						tooltip_div.html(msg)
							.style("left", (e.pageX) + "px")
							.style("top", (e.pageY - 28) + "px");
						setTimeout(hideToolTip, 2000);
        }

        function hideToolTip(){
                        tooltip_div.transition()
                        .duration(500)
                        .style("opacity", 0);
        }

        function addNewValues(){
                var value = $("#add-new-values-input").val();
                if (! value){
                        return;
                }
                var ids = the_tree.getSelectedIDs();
                var len = ids.length;
                if (len ===0){
                        return;

                }
                var field = $("#add-new-values-select").val();

                var meta = {};
                for (var i in ids){
                        var id = ids[i];
                        var obj={}
                        obj[field]=value;
                        meta[id]=obj;

                }
                the_tree.addMetadata(meta);
                the_tree.changeCategory(field);
		the_tree.clearSelection();
		updateMetadataTable();
        }


        function addExtraField(){
                var name = $("#add-extra-field-input").val();
                if (!name){
                        return;
                }
                addMetadataOptions(name,name);
                $("#metadata-select").val(name);
                $("#add-new-values-select").val(name);
                the_tree.changeCategory(name);
				updateMetadataTable();
        }

        function treeLoaded(tree){

                tree.legendItemClicked = function(data){
                        legend_colour_chooser
                        .css({"left":0,"top":0})
                        .val(data.colour)
                        .data({"value":data.value,"category":data.category})
                        .trigger("click");
                };


				$( "#spinner-collapse-nodes" ).spinner({
                        min: 0,
                        max: tree.max_link_distance*2,
                        value: tree.node_collapsed_value,
                        step: (tree.max_link_distance/1000.0).toPrecision(1)
                });

                $( "#slider-collapse-nodes" ).slider({
                        min:Math.log(tree.max_link_distance/1000)*1000,
                        max: Math.log(tree.max_link_distance*2)*1000,
                        value: Math.log(tree.node_collapsed_value)*1000,
                });
                tree.centerGraph();
                for (var index in all_files){
			if (all_files[index].name === metadata_file_name){
				loadMetadataFile(all_files[index],current_metadata_file[1]);
				break;
			}
                }
		$(waiting_spinner.el).hide();
                 $("#waiting-information").text("Complete. Tree has "+tree.force_nodes.length+" nodes");
                 $("#waiting-image").attr("src","js/img/ms_complete_1.png").show();
               // legend_colour_chooser.hide();
		$("#information-div").modal("hide");

        }

        function treeLoading(tree,msg){
                if (msg==='complete'){
                        treeLoaded(tree);
                }
                else{

                        $("#waiting-information").text(msg)

                }

        }


        function loadTreeFile(file){
              initiateLoading("Processing "+file.name)
              //give time to dialog to display
              setTimeout(function(){
                        readFile(file,function(tree){
                                 var data={};
								 var suffix = getSuffix(file.name);
                                 if (suffix === 'json'){
                                     data =JSON.parse(tree);
                                 }
                                 else if (tree.substring(0,6)==="#NEXUS"){
                                        data['nexus']=tree;
										data['layout_algorithm']=$("#layout-select").val();
                                 }
                                 else{
                                        data['nwk']=tree;
										data['layout_algorithm']=$("#layout-select").val();
                                 }
								 tree_raw = data;
                                 loadMSTree(tree_raw);
                        });
                },500);
        }

        function readFile(file,callback){
                var reader = new FileReader();
                reader.onload = function(progressEvent){
                        callback(this.result);
                }
                reader.readAsText(file);
        }




        function loadFailed(msg){
		$("#information-div").modal("show");
		$(waiting_spinner.el).hide();
                $("#waiting-image").attr("src","js/img/ms_failed_1.png").show();
                $("#waiting-information").text(msg);
        }

	function setControlPanel(data){
		$("#slider-linklength").slider("value",Math.log(data['max_link_scale']/5.)*1000.0);
		$("#spinner-linklength").val(data['max_link_scale']/5.);

		$("#slider-nodesize").slider("value",data['base_node_size']*10);
		$("#spinner-nodesize").val(data['base_node_size']*10);

		if (data['max_link_length']){
			$("#spinner-maxlinklength").val(data['max_link_length']);
		}
		if (data['size_power']){
			$("#slider-relative-nodesize").slider("value",data['size_power']*200.0);
			$("#spinner-relative-nodesize").val(data['size_power']*200.0);
		}

		if (data['log_link_scale']){
			$('#link-log-scale').prop('checked', true);
		}
		if (data['show_individual_segments']){
			$("#show-individual-segments").prop("checked",true);
		}
		if (data['link_font_size']){
			$("#slider-linkfontsize").slider("value",data['link_font_size']);
			$("#spinner-linkfontsize").spinner("value",data['link_font_size']);
		}
		var sll =true;
		if (data['show_link_labels']===false){
			sll= false;
		}

		$("#show-link-labels").prop("checked",sll);
		$("#show-node-labels").prop("checked",data['show_node_labels']);
		if (data['node_font_size']){
			$("#slider-node-fontsize").slider("value",data['node_font_size']);
			$("#spinner-node-fontsize").spinner("value",data['node_font_size']);
		}
		if (data['hide_link_length']){
			$("#spinner-hide-link-length").val(data['hide-link-length']);
		}
		$( "#slider-collapse-nodes" ).slider("value",Math.log(data["node_collapsed_value"])*1000);
		$("#spinner-collapse-nodes").val(data["node_collapsed_value"])
	}



        function loadMSTree(data){
				if (the_tree) {
					the_tree.svg.remove();
					the_tree.legend_div[0].remove();
				}
                $("#waiting-information").text("Loading Data");
                the_tree = null;

            //    try{
					the_tree = new D3MSTree(
					"graph-div",data,function(tree,msg){
							treeLoading(tree,msg);

					});

					the_tree.addSegmentOverListener(function(d){
							if ($("#show-node-tooltip").prop("checked")){
									var display = d.data.type;
									if (d.data.node_id){
											display = d.data.node_id;
									}
									showToolTip(display+"("+d.data.value+")");
							}
					});
					the_tree.addSegmentOutListener(function(d){
							 hideToolTip();
					});
					the_tree.addLinkOverListener(function(d){
							if ($("#show-link-tooltip").prop("checked")){
									showToolTip("length:"+d.value);
							}

					});
					the_tree.addLinkOutListener(function(d){
							hideToolTip();
					});
					the_tree.resize();
					
					// metadata
					if (!metadata_options['nothing']){
                        metadata_options['nothing']='No Category';
						$("#metadata-select").append($("<option>").attr("value",'nothing').text('No Category'));
					}
					addMetadataOptions('ID','ID');
					$("#metadata-select").val('nothing');
					$("#node-label-text").val('ID');

					if (data['metadata_options']){
							for (var key in data['metadata_options']){
								   addMetadataOptions(key,data['metadata_options'][key]);
							}
					}
					if (data['initial_category']){
						$("#metadata-select").val(data['initial_category']);
					}
					if (data['layout_data'] && data['layout_data']['nodes_links']){
						setControlPanel(data['layout_data']['nodes_links'])
					}
					else{
						setControlPanel(default_control_panel_values);
					}
					if (current_metadata_file) {
						loadMetadataFile(current_metadata_file[0], current_metadata_file[1]);
					} else {
						updateMetadataTable();
					}
 /*               }catch(e){
						console.log(e.message);
						console.log(e.stacktrace);
						loadFailed("The file could not be read. Plase check the format");

                }*/
		$('.panel-default').find('input, textarea, button, select, div, span').css("opacity", 1.0).prop('disabled',false);
	}

var current_metadata_file=null;
 function filesDropped(files){
	current_metadata_file=null;
	var tree_file=null, profile_file =null;
	for (var i=0;i<files.length;i++){
		var file = files[i];
		var first_blob = file.slice(0, 2048);
		var reader = new FileReader();
		reader.onload = function(progressEvent){
			var head_line = this.result.split(/[\n\r]/)[0];

			if ((head_line.startsWith(">")  || (head_line.startsWith("#")) && ! head_line.startsWith("#NEXUS") && !head_line.startsWith("#nexus"))) {
				if (cannot_connect){
					loadFailed("Cannot Connect to the backend server");
					return;
				}
				profile_file=this.file;
				initiateLoading("Reading Profile File");
				$("#param-panel").show();
				$("#modal-ok-button").data("profile_file",profile_file);
				$("#modal-ok-button").html("OK");
				$(waiting_spinner.el).hide();
				$("#modal-title").show().text("Parameters For Tree Creation");
				$("#waiting-information").hide();
				document.getElementById("headertag").innerHTML = this.file.name;
			}

			else if ((head_line.indexOf(",") >=0 || head_line.indexOf("\t")>=0) && !head_line.startsWith("(") && !head_line.startsWith("{")) {
				var dl = (head_line.indexOf(",") >= 0 ? "," : "\t");
				current_metadata_file=[this.file, dl];
				metadata_file_name = this.file.name;
				if (the_tree) loadMetadataFile(current_metadata_file[0], current_metadata_file[1]);
			}
			else {
				tree_file = this.file;
				loadTreeFile(tree_file);
				document.getElementById("headertag").innerHTML = this.file.name;
			}
		};
		reader.file = file;
		reader.readAsText(first_blob);
	}
 }

 function initiateLoading(msg){
	$("#welcome-div").hide();
	$("#graph-div").empty();
	$("#metadata-select").empty();
	$("#add-new-values-select").empty();
	metadata_options={};
	showWaitingDialog(msg);

 }

function showModalForParams(){
	$("#information-div").modal("show");
	$("#param-panel").show();
}

tree_raw = {};
 function processProfileFile(profile_file){


        readFile(profile_file,function(profile){
              try{
                $.ajax({
                        method: "POST",
                        url: "/maketree",
                        data: {
				profile:profile,
				method:$("#method-select").val(),
				matrix_type:$("#matrix-select").val(),
				edge_weight:$("#edge-weight-select").val(),
				neighbor_branch_reconnection:$("#branch-select").val(),
				missing_data:$("#missing-data").val()
				}
                }).done(function(result){
						tree_raw = {"nwk":result,"layout_algorithm":$("#layout-select").val()};
						loadMSTree(tree_raw);
               }).fail(function( jqXHR, textStatus){
						if (jqXHR.status == 405 || jqXHR.status == 404) {
							loadFailed("Cannot reach the backend. Please download a FREE standalone version from https://github.com/martinSergeant/EnteroMSTree/");
						} else {
							console.log(textStatus);
							loadFailed("There server returned an error. Is the profile file in the right format");
						}
               });
               }catch(e){
                        loadFailed("The server could not be contacted");
               }
                $("#waiting-information").text("Computing Tree");
        });
 };

 function showWaitingDialog(msg){
	$("#information-div").modal("show");
	$("#waiting-image").hide();
	$(waiting_spinner.el).show();
	$("#waiting-information").text(msg).show();
 }





 function loadMetadataFile(file, dl){
	MSCSCReader(file,dl,function(msg,lines,header_index){
		var meta={};
		var id_name='ID';
		var exp = new RegExp("ID","i");
		for (var i in header_index){
			var header = header_index[i];
			if (header.match(exp)){
				id_name=header;
				header_index[i]='ID';
				break;
			}
		}

		for (var i in lines){
			var line = lines[i];
			if (id_name !== 'ID'){
				line['ID']=line[id_name];
				delete line[id_name];
			}
			if (line['Name']){
				meta[line['Name']]=line;
			}
			else if (line['ID']){
				meta[line['ID']]=line;
			}
		}
		the_tree.addMetadata(meta);

		var category = 'nothing';
		for (var i in header_index){
			var header = header_index[i];
			addMetadataOptions(header, header);
			if ( category == 'nothing' && header != 'ID'){
				category=header;
			}
		}
		$("#metadata-select").val(category);
		the_tree.changeCategory(category);
		updateMetadataTable();
	});
 };



window.onload = function (){
	$(".show-tooltip").on('mouseenter', function(e){
		showToolTip($(this).attr('title'), {pageX:$(this).offset().left + $(this).width() + 10, pageY:$(this).offset().top + $(this).height()/2+10});
	}).on('mouseleave', function(e) {
		setTimeout(hideToolTip, 200);
	});

        //allow dragging and dropping files
        $("#graph-div").on('dragover',function(e) {
                e.preventDefault();
                e.stopPropagation();
            }
        )
        .on('dragenter',function(e) {
                e.preventDefault();
                e.stopPropagation();
                }
        )
        .on("drop",function(e){
                e.originalEvent.stopPropagation();
                e.originalEvent.preventDefault();
                var files = e.originalEvent.dataTransfer.files;
                filesDropped(files);
        });

        $("#stopAdjustment").click(function(e) {
			the_tree.fixAllNodes( document.getElementById("correct_link_length").checked );
	    });

        $("#upload-metadata-icon").click(function(e){
                if (!metadata_options['Custom Fields']){
                        Enterobase.modalAlert("Please add a custom field before uplaoding a file containing values for this field");
                        return;
                }
                var i = Enterobase.makeCustomFileInput("fileupload",function(file){
                        uploadMetadata(file);
                });
                i.trigger("click");
        });

        $("#metadata-select").on("change",function(e){
                the_tree.changeCategory($(this).val());
        });
        $("#node-label-text").change(function(e){
               the_tree.setNodeText($(this).val());
        });

        $(window).resize(function(){
                var winh = ($(window).height())-15;
                var winw = ($(window).width());
                var div  = $("#graph-div");
                var sb_width = $("#sidebar").width();
                div.height(winh).css({"max-height":winh+"px","min-height":winh+"px"});
                $("#graph-div").width(winw-sb_width);
        });
        $(window).trigger("resize");


        $("#mst-download-svg").click(function(e){
                the_tree.downloadSVG(tree_name);
        });


        $(".mst-menu-title").click(function(e){
				if($(this).prop("disabled") === true) {
					return;
				}
                var id = $(this).attr("id");
                var this_panel =  $("#"+id+"-panel");
                var icon = $("#"+id+"-icon");
                if  (this_panel.hasClass("open-menu-panel")){
                        this_panel.toggle("50");
                        this_panel.removeClass("open-menu-panel");
                        icon.attr("class","glyphicon glyphicon-menu-right");
                }
                else{
                        $("#"+id+"-panel").toggle("50");
                        icon.attr("class","glyphicon glyphicon-menu-down");
                        $("#"+id+"-panel").addClass("open-menu-panel");
                }

        });
        $(".panel-body").hide();

        $( "#slider-linklength" ).on("change", function(e) {
					var brlen = Math.exp($(this).slider("value")/1000.0);
					$("#spinner-linklength").spinner('value', brlen);
		})
		.slider({
                orientation: "horizontal",
                min: 1609,
                max: 9903,
                value: 4605,
        });
		
		$("#spinner-linklength").on("change", function (e){
				var brlen = parseInt($(this).val());
				$( "#slider-linklength" ).slider('value', Math.log(brlen)*1000.0);
				the_tree.setLinkLength(brlen*5.0);
		})
		.spinner({
			min: 5,
			max: 20000,
			value: 100,
			step: 1,
		});
		$(".slider-class").slider({
			slide: function(e) {
				$(this).trigger('change');
			},
			change: function(e) {
				if (e.originalEvent) {
					$(this).trigger('change');
				}
			}
		});
		$(".spin-group").spinner({
			spin: function(e) {
				$(this).trigger('change');
			},
			change: function(e) {
				$(this).trigger('change');
			}
		}).keypress(function(e){
			if (e.which === 13) {
				$(this).spinner("value", $(this).val());
			}
		});

        $( "#slider-nodesize" ).on("change", function(e) {
			$( "#spinner-nodesize" ).spinner("value", $(this).slider("value"));
		})
		.slider({
                orientation: "horizontal",
                min:20,
                max:500,
                value: 100,
        });
        $( "#spinner-nodesize" ).on('change', function(){
						the_tree.setNodeSize(parseInt($(this).val())/10.);
						$( "#slider-nodesize" ).slider("value", parseInt($(this).val()));
					})
		.spinner({
                min:20,
                max:500,
                value: 100,
        });


        $( "#slider-relative-nodesize" ).on("change", function(e) {
			$( "#spinner-relative-nodesize" ).spinner("value", $(this).slider("value"));
		})
		.slider({
                orientation: "horizontal",
                min:30,
                max:150,
                value: 100,
                step:1,
        })
		$( "#spinner-relative-nodesize" ).on("change", function(e){
			the_tree.setRelativeNodeSize(parseInt($(this).val())/200.0);
			$( "#slider-relative-nodesize" ).slider("value", parseInt($(this).val()));
		})
		.spinner({
                min:30,
                max:150,
                value: 100,
                step:1,
        });

        $( "#slider-node-fontsize" ).on("change", function(e) {
			$("#spinner-node-fontsize").spinner('value', $(this).slider("value"));
		})
		.slider({
                orientation: "horizontal",
                min:6,
                max: 30,
                value: 12,
        });
		$("#spinner-node-fontsize").on("change", function(e) {
				$( "#slider-node-fontsize" ).slider('value', parseInt($(this).val()));
				the_tree.setNodeFontSize(parseInt($(this).val()));
		})
		.spinner({
			min: 6,
			max: 30,
			value: 12,
		});

        $( "#slider-linkfontsize" ).on("change", function(e) {
			$("#spinner-linkfontsize").spinner('value', $("#slider-linkfontsize").slider("value"));
		})
		.slider({
                orientation: "horizontal",
                min:6,
                max: 30,
                value: 14,
        });
		$("#spinner-linkfontsize").on("change", function(e) {
				$( "#slider-linkfontsize" ).slider('value', parseInt($(this).val()));
				the_tree.setLinkFontSize(parseInt($(this).val()));
		})
		.spinner({
			min: 6,
			max: 30,
			value: 14,
		});


        $( "#slider-charge" ).on("change", function(e) {the_tree.alterCharge($("#slider-charge").slider("value"));
									$(this).prop("title", $(this).slider("value"));
		})
		.slider({
                orientation: "horizontal",
                min:0,
                max: 30,
        });

        $("#node-label-text").change(function(e){
                var val = $(this).val();
                if (val ==="cat"){
                        val = the_tree.display_category;
                }
                the_tree.setNodeText(val);
        });


        $("#spinner-maxlinklength").spinner({
                min:100,
                step:100
        })

        $("#spinner-hide-link-length").spinner({
                min:1,
                step:10000
        });
        $("#button-setmaxlinklength").click(function(){
                var max  = $("#spinner-maxlinklength").val();
                if (max){
                        the_tree.setMaxLinkLength(max);
                }
        });
        $("#button-hide-link-length").click(function(){
                var max  = $("#spinner-hide-link-length").val();
                if (max){
                        the_tree.setHideLinkLength(max);
                }
        });
        $("#button-refresh").click(function(){
		showWaitingDialog("Refreshing The Tree");
		setTimeout(function(){
			the_tree.refreshGraph();
			$("#information-div").modal("hide");
		},500)

        });
        $("#show-link-labels").click(function(e){
                the_tree.showLinkLabels($(this).is(":checked"))
        });
        $("#show-node-labels").click(function(e){
                the_tree.showNodeLabels($(this).is(":checked"));
        });
        $("#show-individual-segments").click(function(e){
                the_tree.showIndividualSegments($(this).is(":checked"));
        });

        $("#show-node-tooltip").click(function(e){
                show_node_tooltips = $(this).is(":checked");
        });

        $("#link-log-scale").click(function(e){
                the_tree.setLogLinkScale($(this).is(":checked"));
        });

        $("#button-load-nwk").click(function(e){
                file_chooser.setFilter("");
                file_chooser.showOpenDialog(function(files){
                        filesDropped(files);

                });
        });

          $("#button-load-meta").click(function(e){
                file_chooser.setFilter(".txt,.csv");
                file_chooser.showOpenDialog(function(files){
                        filesDropped(files);
                });
        });




         $( "#slider-collapse-nodes" ).on("change", function(e) {
				var val = Math.exp($(this).slider('value')/1000);
                $("#spinner-collapse-nodes").spinner('value', val);
		 })
		 .slider({
                orientation: "horizontal",
                min:0,
                max: 100,
                value: 0,
        });
		$( "#spinner-collapse-nodes" ).on("change", function(e) {
			var v = parseFloat($(this).spinner('value'));
			$("#slider-collapse-nodes").slider('value', Math.log(v)*1000);
			the_tree.collapseNodes(v);
		 })
		 .spinner({
                min:0,
                value: 0
        });



        $("#save-tree-json").click(function(e){
                var obj= the_tree.getTreeAsObject();
                obj['metadata_options']=metadata_options;
                saveTextAsFile(JSON.stringify(obj),"ms_tree.json");

        });

        $("#save-tree-nwk").click(function(e){
                var newick= the_tree.getTreeAsNewick();
                saveTextAsFile(newick,"ms_tree.nwk");

        });


        $("#center-graph-button").click(function(e){
             the_tree.centerGraph();

        });

	$("#search-metadata-icon").click(function(e){
		var keyword= $("#search-metadata-input").val();
		if (!keyword){
			return;
		}
		var ids = the_tree.searchMetadata(keyword, $("#node-label-text").val());
		the_tree.highlightNodes(ids);
	});

	$("#modal-ok-button").click(function(e){
		var profile_file =  $(this).data("profile_file")
		if (profile_file){
			processProfileFile(profile_file);
			$(this).data("profile_file",null);
			$("#modal-oj-button").html("Close");
			$("#param-panel").hide();
			e.stopImmediatePropagation();
			$("#modal-title").hide();
			showWaitingDialog("Processing Profiles");
		}
	});

        $("#method-select").change(function(e) {
			if ($(this).val() == "MSTree") $("#MST-option").show();
			else $("#MST-option").hide();
		})

        $("#matrix-select").change(function(e) {
			if ($(this).val() == "symmetric") $("#symmetric-option").show();
			else $("#symmetric-option").hide();
		})

		$("#graph-div").on('dblclick', function(e){
		    if (the_tree) the_tree.clearSelection();
       })
	try_backend();
	var target = document.getElementById('modal-header')
	waiting_spinner= new Spinner({color:'black', lines: 12,top:"13%"}).spin(target);


	$('.panel-default').find('input, textarea, button, select, span, div').css("opacity", 0.3).prop('disabled',true);
	$("#file-menu-panel").css("opacity", 1.0).show();
	$("#button-load-nwk").css("opacity", 1.0).prop("disabled", false).trigger('mouseenter');
	

	window.addEventListener("beforeunload", function (e) {
		if (the_tree) {
			var confirmationMessage = 'All the modifications will lost if you have not saved the GrapeTree as a local file.';
			(e || window.event).returnValue = confirmationMessage;
			return confirmationMessage;
		}
	});
};

function try_backend(){
  try{
	$.ajax({
			method: "POST",
			url: "/maketree",
	}).done(function(result){})
	.fail(function( jqXHR, textStatus){
		if (jqXHR.status != 406) {
			cannot_connect=true;
		}
    });
   }catch(e){
		cannot_connect=true;
   }
 };
</script>
<script src="js/tree/context.js"></script>
</body>
</html>
