
<!DOCTYPE html>
<html>
<head>
        
        <link rel="stylesheet" href="js/jquery-ui-1.11.4/jquery-ui.min.css">
         <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style>
                body{
                        width:100%;
                        height:100%;
                }
                
                #graph-div{
                      
                        position: absolute;
                        top:10px;
                        left:170px;
                        
                }
                
                #sidebar {
                        position:absolute;
                        top:10px;
                        width:170px;
                        margin-left:5px;
                }
                .brush .extent {
                                        stroke: #fff;
                                        fill-opacity: .125;
                                shape-rendering: crispEdges;
                                }
                .selected{
                        background-color:blue;
                }
             

                .graph-selection-indicator {
                  position: absolute;
                  background: transparent;
                  border: 1px solid orange;
                }
                 .slider-class{
                        float: left;
                        clear: left;
                        width: 140px;
                        height:5px;
                        margin: 5px;
                }
                .slider-class .ui-slider-handle {		
                        height:12px;
                }
                .mst-menu-title {
                        
                        cursor:pointer;
                        
                }
                .panel-body label{
                        margin-bottom:1px;
                        margin-top:4px;
                
                }
                .zoom-icon{
                        cursor:pointer;
                        font-size:22px;
                
                }
                .upload-download-icon{
                        cursor:pointer;
                        font-size:22px;
                
                }
                .add-data-icon{
                        cursor:pointer;
                        float:right;
                }
                .mst-menu-title span{
                        display:block;
                        float:right;	
                }
                .panel-default{
                        margin-bottom:2px;
                }
                div.tooltip {	
                        position: absolute;			
                        text-align: center;			
                        //width: 60px;					
                        height: 28px;					
                        padding: 2px;				
                        font: 16px sans-serif;		
                        background: lightsteelblue;	
                        border: 0px;		
                        border-radius: 8px;			
                        pointer-events: none;			
                }
                        
              
        </style>
        

</head>
<body>


<div id='sidebar'>
        
        
        
        <label>Colour By:</label>
        <br>
        <select style="width:140px" id= 'metadata-select'></select>
        
        <p align = 'center'>
        <span onclick= "javascript:the_tree.setScale(1.1,true)" class=' zoom-icon glyphicon glyphicon-zoom-in'></span>
        <span onclick= "javascript:the_tree.setScale(0.9,true)"class='zoom-icon glyphicon glyphicon-zoom-out'></span>
        </p>
        
     <div class='panel panel-default'  style ="margin-bottom:2px">	
               <div class ='panel-heading mst-menu-title' id= 'mst-link-menu'> <b id>Links</b><span id = 'mst-link-menu-icon' class='glyphicon glyphicon-menu-right'> </span></div>
               <div class = "panel-body" id ='mst-link-menu-panel'>	
                       <label>Link Length</label>
                       <br>
                       <div id = "slider-linklength" class ="slider-class">  </div>
                       <br>
                        <label><input id ='link-log-scale'type="checkbox"  />Log Scale</label>
                        <br>
                        <label>Hide Links Over:</label>
                        <br>
                        <input type='text' style='width:35px;height:15px' id ='spinner-hide-link-length'>
                       <button id ='button-hide-link-length'>Go</button>
                       <br>
                       <label>Max Link Length:</label>
                       <br>
                       <input type='text' style='width:35px;height:15px' id ='spinner-maxlinklength'>
                       <button id ='button-setmaxlinklength'>Go</button>
                       <br>
                       <label><input id ='show-link-labels'type="checkbox" checked /> Link Labels</label>
                       <br>
                       <label>Font Size</label>
                       <br>
                       <div id = "slider-linkfontsize" class = "slider-class"></div>
                       <br>
                       <label><input id ='show-link-tooltip' type="checkbox" checked /> Show Tooltip</label>
               </div>
       </div>
       <div class='panel panel-default'>	
               <div class ='panel-heading mst-menu-title' id= 'mst-node-menu'> <b id>Nodes</b><span id = 'mst-node-menu-icon' class="glyphicon glyphicon-menu-right"></span></div>
               <div class = "panel-body" id ='mst-node-menu-panel'>		
                        <label>Node Size</label>
                        <br>
                        <div id = "slider-nodesize" class = "slider-class"></div>
                        <br>
                        <label>Relative Size</label>
                        <br>
                        <div id = "slider-relative-nodesize" class = "slider-class"></div>
                        <br>
                        <label><input id ='show-node-labels'type="checkbox" checked /> Node Labels</label>
                        <br>
                        
                        <label>Font Size</label>
                        <br>
                        <div id = "slider-node-fontsize" class = "slider-class"></div>
                        <label>Label Text</label>
                        <!--<select id = 'node-label-text'>
                                <option value = ''>ST</option>
                                <option value = 'cat'>Category</option>
                                <option value = 'Name' >Strain Name</option>
                        <select>-->
                        <div id = 'metadata-placeholder'></div>
                        <br>
                        <label><input id ='show-node-tooltip' type="checkbox" checked /> Show Tooltip</label>
                        <br>
                        <label><input id ='show-individual-segments' type="checkbox" /> Show All Segments</label>
                </div>
        </div>
        <div class='panel panel-default'>	
                <div class ='panel-heading mst-menu-title' id= 'mst-layout-menu'> <b id>Layout</b><span id = 'mst-layout-menu-icon' class="glyphicon glyphicon-menu-right"></span></div>
                <div class = "panel-body" id ='mst-layout-menu-panel'>
                          <label>Collapse Nodes::</label>
                        <br>
                        <input type='text' style='width:35px;height:15px' id ='spinner-collapse-nodes'>
                       <button id ='button-collapse-nodes'>Go</button>
                       <br>
                       <br>
                        <p align='center'>
                                <button onclick ="javascript:the_tree.unfixSelectedNodes()"> Unfix Selected</button>
                        </p>
                        <p align='center'>
                                <button onclick = 'javascript:the_tree.unfixSelectedNodes(true)' > Unfix All</button>
                        </p>
                        <p align='center'>
                                <button onclick = 'the_tree.fixAllNodes()' > Fix All</button>
                        </p>
                        <p align='center'>
                                <button onclick = 'the_tree.resetLinkLengths()' > Correct Links</button>
                        </p>	
                        <label>Charge</label>
                        <br>
                        <div id = "slider-charge" class = "slider-class"></div>
                        <br>
                        <p align='center'>
                                <button id = 'button-refresh'> Refresh</button>
                        </p>
                        
                </div>
        </div>
        <div id = 'add-data-panel' class='panel panel-default'>	
                <div class ='panel-heading mst-menu-title' id= 'mst-data-menu'> <b id>Add Data</b><span id = 'mst-data-menu-icon' class="glyphicon glyphicon-menu-right"></span></div>
                <div class = "panel-body" id ='mst-data-menu-panel'>	
                
                         <p align='center'>
                                <button id = 'button-load-nwk'> Load Nwk File</button>
                        </p>
                          <p align='center'>
                                <button id = 'button-load-meta'> Load Metadata</button>
                        </p>
                        
                        <label>Custom Field&nbsp;&nbsp;&nbsp;</label>
                        <input  size="11" id ="add-custom-field-input">
                        <span  id ="add-custom-field-icon" onclick="addCustomField()" class='add-data-icon glyphicon glyphicon-plus'></span>
                        <br>
                        
                        <label>Custom  Value &nbsp;&nbsp;&nbsp;</label>
                        Field<select style ="width:120px" id="custom-field-select"></select>
                        Value<input size="11" id ="add-custom-value-input">
                        <span  id ="add-custom-value-icon"  onclick="addCustomValue()" class='add-data-icon glyphicon glyphicon-plus'></span>
                        <br>
                
                        <label>Upload Values &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;</label>
                        <p align="center">
                        <span  id ="download-metadata-icon"  onclick="downloadMetadata()" class="upload-download-icon glyphicon glyphicon-download"></span>
                        <span  id ="upload-metadata-icon"  class="upload-download-icon glyphicon glyphicon-upload"></span>
                        </p>                                      
                </div>
        </div>
      

          
      
        
        
        <p align='center'>
                <button onclick = 'javascript:the_tree.clearSelection()'> Clear Selection</button>
        </p>
         <p align = 'center'>
                <button id ="center-graph-button">Center Graph</button>
        </p> 
        <p align = 'center'>
                <button id ="save-tree-json">Save Tree</button>
        </p>       
        
        <p align = 'center'>
                <button id ="mst-download-svg">Download SVG</button>
        </p>          
</div>

<div id = "graph-div" class="graph-overlay"></div>


        
<script src="js/main/jquery-1.9.1.min.js"></script>
<script src ="js/jquery-ui-1.11.4/jquery-ui.min.js"></script>
<script charset="utf-8" src="js/main/d3.min.js"></script>
<script charset="utf-8" src="js/tree/base_tree.js"></script>
<script charset="utf-8" src="js/tree/d3_m_tree.js?version=0.1409"></script>



<script>
        MSFileChooser.prototype = Object.create(null);
        MSFileChooser.prototype.constructor= MSFileChooser;
        
        function MSFileChooser(filter){
                var self = this;
                this.fileInput = $("<input>").attr("type","file").css("display","none");
                this.callback=null;
                this.fileInput.attr("accept",filter);
                $('<body>').append(this.fileInput);         
                this.fileInput.change(function(event){  
                        self.callback(event.target.files);

                });
        
        }
        MSFileChooser.prototype.setFilter=function(filter){
                this.fileInput.attr("accept",filter);
        }
        MSFileChooser.prototype.showOpenDialog=function(callback){
                this.callback=callback;
                this.fileInput.trigger("click");
        }
        
       
        function MSCSCReader(file,delimiter,callback){
                var reader = new FileReader();
                reader.onload = function(progressEvent){
                        var return_data=[];
                        try{
                                var data =this.result;
                                var lines =  data.split(/\r\n|\r|\n/g);
                                var header = lines[0].split(delimiter);
                                var header_index={}
                                for (var i=0;i<header.length;i++){
                                        header_index[i]=header[i];
                                
                                }
                                
                                for (var i=1;i<lines.length;i++){
                                        var map = {};
                                         var arr = lines[i].split(delimiter);
                                         for (var col in arr){
                                                map[header_index[col]]=arr[col];                          
                                         }
                                         return_data.push(map);
                                }
                               
                        }catch(error){
                                callback("Error",error.message)
                                
                        }
                        callback("OK",return_data,header_index);
                };
                reader.readAsText(file);
        };
        
        function saveTextAsFile (text,suggested_name){
        
                var save = $("<a download><button>Save</button></a>").click(function(){
                        var name=$("#filename").val();
                        if(!name){
                            return;
                        }          
                        //windows - don't actually use the file download anchor
                        if(window.navigator.msSaveOrOpenBlob) {
                            var data = new Blob([text], {type: 'text/plain'});   
                            window.navigator.msSaveBlob(data,name);
                        }
                        //others
                        else{
                            var data = new Blob([text], {type: 'text/plain'});
                           
                            this.textFile = window.URL.createObjectURL(data);
                            //set file name and contents before click event propogates
                            $(this).attr("download",name);
                            $(this).attr("href",this.textFile);
                
                        }
                        $(".ui-dialog-content").dialog().dialog("close");
            
                });       
                //the actual dailog box    
                $("<div id ='savedailog'></div>")
                .html("File Name: <input type='text' id ='filename' value='"+suggested_name+"'>")
                .dialog({
                    autoOpen: true,
                    modal: true,
                    title: "Save File",
                    buttons: {
                        "Cancel": function () {
                           
                            $(this).dialog("close");
                        }
                    },
                    close: function () {
                        $(this).dialog('destroy').remove();
                    }
                }).append(save);
        };
        
        
        

        var summaryDialog = null;
        var waitingDialog = null;
        var grid_window=null;
        var loadingAllelesDialog = null;
        var the_tree = null;
        var tree_name="";
        var tooltip_div =d3.select("body")
                                        .append("div")	
                                        .attr("class", "tooltip")				
                                        .style("opacity", 0);
        var legend_colour_chooser = $("<input>")
                                        .on("change",function(e){
                                                var cc  = $(this);
                                                the_tree.setColour(cc.data("category"),cc.data("value"),cc.val());
                                                the_tree.changeCategory(cc.data("category"));
                                                
                                        })                                  
                                        .attr("type","color");
        $("body").append(legend_colour_chooser);
        
        //a map of group to another map of name to label
        var metadata_options={};
        var new_metadata_fields=[];
        var locus_label ="";
        var file_chooser = new MSFileChooser(".nwk");
        
        
        
                
        function downloadMetadata(){
                var lines= [];
                lines.push("Barcode\tName");
                for (var id in the_tree.metadata){
                        var item = the_tree.metadata[id];
                        var barcode = Enterobase.encodeBarcode(id,db_code);
                        lines.push(barcode+"\t"+item["Name"]);
                        
                }
                var text= lines.join("\n");
                Enterobase.showSaveDialog(text,"tree.json");
        }
        
        function uploadMetadata(file){
                var reader = new FileReader();
                reader.onload = function(progressEvent){
                        var metadata={};
                        var lines =  this.result.split(/\r\n|\r|\n/g);
                        var headers =  lines[0].split("\"").join("").split("\t");
                        var header_index= {};
                        var barcode_column= 0;
                        var is_headers =false;
                        for (var index in headers){
                                if (headers[index]=="Barcode"){
                                        barcode_column= parseInt(index);
                                }
                                if (metadata_options['Custom Fields'][headers[index]]){
                                        header_index[index]=headers[index];
                                        is_headers=true;
                                
                                }
                        }
                        if (! is_headers){
                                Enterobase.modalAlert("No Headers match any custom fields");
                                return;
                        
                        }
                
                        for(var n= 1; n < lines.length; n++){ //>
                                
                                var values =  lines[n].split("\"").join("").split("\t");
                                var barcode = values[barcode_column];
                                if (!barcode){
                                        continue;
                                }
                                var id  = Enterobase.decodeBarcode(barcode);
                                metadata[id]={}
                                for (var index in header_index){
                                        metadata[id][header_index[index]]= values[index]		
                                }			
                        }
                        the_tree.addMetadata(metadata);
                };
          reader.readAsText(file);
        }
        
        function displayErrorMessage(msg){
                Enterobase.modalAlert(msg);
        }
        
        function setMetadataOptions(data){
                var sel = $("#metadata-select");
                sel.empty();
                for (var group in data){
                        //remove from AddExperimentalData
                        $("#scheme-data option").filter(function(){
                                return this.text==group;
                        }).remove();
                        
                        var opt_group = $("<optgroup>").attr("label",group);
                        sel.append(opt_group);
                        metadata_options[group]={};
                        var group_options = data[group];
                        for (var val in group_options){
                                opt_group.append($("<option>")
                                        .attr("value",val)
                                        .text(group_options[val]));
                                metadata_options[group][val]=group_options[val];
                                if (group === 'Custom Fields'){
                                        $("#custom-field-select").append($("<option>")
                                                .attr("value",val)
                                                .text(group_options[val]));
                                }
                        }			
                }
        }
        
        
        function showToolTip(msg){
                        tooltip_div.transition()		
                        .duration(200)		
                        .style("opacity", .9);		
                        tooltip_div.html(msg)	
                        .style("left", (d3.event.pageX) + "px")		
                        .style("top", (d3.event.pageY - 28) + "px");
        }
        
        function hideToolTip(){
                        tooltip_div.transition()		
                        .duration(500)		
                        .style("opacity", 0);	
        }
        
        
        
        
        
        function addCustomValue(){
                var value = $("#add-custom-value-input").val();
                if (! value){
                        return;
                }
                var ids = the_tree.getSelectedIDs();
                var len = ids.length;
                if (len ===0){
                        Enterobase.modalAlert("There are no nodes selected in the Tree");
                        return;
                
                }
                else{
                        var field = $("#custom-field-select").val();
                        if (new_metadata_fields.indexOf(field)===-1){
                                new_metadata_fields.push(field);
                        }		
                        var meta = {};
                        for (var i in ids){
                                var id = ids[i];
                                var obj={}
                                obj[field]=value;
                                meta[id]=obj;
                        
                        }
                        the_tree.addMetadata(meta);
                        the_tree.changeCategory(field);	
                }
        }	
        
        
        function addCustomField(){
                var name = $("#add-custom-field-input").val();
                if (!name){
                        return;
                }
                var opt_group= null;
                var sel = $("#metadata-select");
                if (!metadata_options['Custom Fields']){
                        metadata_options['Custom Fields']={}
                        opt_group = $("<optgroup>").attr("label","Custom Fields");
                        sel.append(opt_group);
                
                }
                else{
                        opt_group = $("[label='Custom Fields']");
                
                }	
                opt_group.append($("<option>")
                .attr("value",name)
                .text(name));
                $("#custom-field-select").append($("<option>")
                .attr("value",name)
                .text(name));
                metadata_options["Custom Fields"][name]=name;
                new_metadata_fields.push(name);
                $("#add-custom-field-input").val("");
                
                Enterobase.modalAlert("A new Field has been added. You can associate values for this field with strains by uploading a file "+
                                                   "or you can associate values with nodes by selecting them and adding a custom value");
        
        }
        
        function treeLoaded(){
                the_tree.legendItemClicked = function(data){    
                        legend_colour_chooser
                        .css({"left":0,"top":0})
                        .val(data.colour)
                        .data({"value":data.value,"category":data.category})
                        .trigger("click");         
                };
              
        
                legend_colour_chooser.css("visibility","hidden");             
        }
        
        
        function loadNewickFile(file,callback){               
                var reader = new FileReader();
                reader.onload = function(progressEvent){
                        var data ={nwk:this.result};
                        loadMSTree(data);
                        if (callback){
                                callback();
                        }
                }
                reader.readAsText(file);
        }
        
        function loadNexusFile(file,callback){
                var reader = new FileReader();
                reader.onload = function(progressEvent){
                        var data ={nexus:this.result};
                        loadMSTree(data);    
                        if (callback){
                                callback();
                        }
                }
                reader.readAsText(file);
        }
        
        function loadJSONFile(file,callback){
                var reader = new FileReader();
                reader.onload = function(progressEvent){
                        var data =JSON.parse(this.result);
                        loadMSTree(data);    
                        if (callback){
                                callback();
                        }
                }
                reader.readAsText(file);
        }
        
        
        
        
   
        
        
        
        
        
        
        function addDataFromFile(file){
                var reader = new FileReader();
                reader.onload = function(progressEvent){
                        var data =JSON.parse(this.result);
                       /* var new_identifiers=[];
                        for (var index in data['identifiers']){
                                var list = data['identifiers'][index];
                                if (list.length===0){
                                        new_identifiers.push("hypothetical_node");
                                }
                                else{
                                        new_identifiers.push("ST"+list[0]);
                                
                                }
                        }
                        data["identifiers"]=new_identifiers;
                        */
                        loadMSTree({data:data});
                        
                }
                reader.readAsText(file);
}
        
        function loadMSTree(data){
                the_tree = null;
                $("#graph-div").empty();
                the_tree = new D3MSTree(
                        "graph-div",data                   
                );

        
        //set the tooltips
                the_tree.segmentMouseOver=function(d){
                        if ($("#show-node-tooltip").prop("checked")){
                                showToolTip(d.data.type+"("+d.data.value+")");
                        }
                };
                the_tree.segmentMouseOut=function(d){
                        hideToolTip();	
                };
                the_tree.linkMouseOver=function(d){
                        if ($("#show-link-tooltip").prop("checked")){
                                showToolTip("length:"+d.value);
                        }
                        
                };
                the_tree.linkMouseOut=function(d){
                        hideToolTip();	
                };
                the_tree.resize();
                if (data['metadata_options']){
                        metadata_options=data['metadata_options'];
                        for (var key in metadata_options){
                                $("#metadata-select").append($("<option>")
                                               .attr("value",key)
                                                .text(metadata_options[key]));             
                        }
                }
                treeLoaded();
               
     //   var a = $("#metadata-select").clone();
     //   a.attr("id","node-label-text");
        
      //  $("#metadata-placeholder").append(a);
      //  a.prepend($("<option>").attr("value","Name").text("Strain Name"));
     //   a.prepend($("<option>").attr("value","node_id").text("ST"));
     
     //   a.val("ST");
    //     a.change(function(e){
  //              var val = $(this).val();
        
 //               the_tree.setNodeText(val);
      //  });
        }
 function filesDropped(tree_file,metadata_file,tree_type){
       if (tree_type==='nexus'){
                loadNexusFile(tree_file,function(){
                        if (metadata_file){
                             loadMetadataFile(metadata_file);
                        }
                });
       
       }
       else if (tree_type==='newick'){
                loadNewickFile(tree_file,function(){
                        if (metadata_file){
                             loadMetadataFile(metadata_file);
                        }
                });
           
       }
       else if (tree_type==='json'){
                loadJSONFile(tree_file);     
       }
 }
 
 
 
 function loadMetadataFile(file){
        MSCSCReader(file,"\t",function(msg,lines,header_index){
                var meta={};
                for (var i in lines){
                        var line = lines[i];
                        meta[line['ID']]=line;
                      
                }
                the_tree.addMetadata(meta);
                for (var i in header_index){
                        var header = header_index[i];
                        if (!metadata_options[header]){
                                metadata_options[header]=header;
                                $("#metadata-select").append($("<option>")
                                               .attr("value",header)
                                                .text(header));                      
                        }
                }   
        });
 }



window.onload = function (){
         document.title =  tree_name;
        $("#graph-div").on('dragover',function(e) {
                e.preventDefault();
                e.stopPropagation();
            }
        )
        .on('dragenter',function(e) {
                e.preventDefault();
                e.stopPropagation();
                }
        )
       
        .on("drop",function(e){
                e.originalEvent.stopPropagation();
                e.originalEvent.preventDefault();
                var files = e.originalEvent.dataTransfer.files;
        
                var tree_file=null;
                var metadata_file = null;
                var tree_type=null;
                for (var i=0;i<files.length;i++){
                        var file = files[i];
                        var file_name =file['name'];
                        var suffix = file_name.split(".");
                        suffix = suffix[suffix.length-1];
                        if (suffix === 'nwk' || suffix ==='nex' || suffix ==='tre'){
                                tree_file=file;
                                tree_type='nexus';
                                if (suffix==='nwk'){
                                        tree_type= 'newick';                           
                                }                    
                        }
                        if (suffix==='txt'){
                                metadata_file=file  
                        }
                        if (suffix==='json'){
                                tree_type="json";
                                tree_file=file;
                        }
                }
                if (tree_file){
                        filesDropped(tree_file,metadata_file,tree_type)
                }
        
        });
        
                
       
                
        $("#upload-metadata-icon").click(function(e){
                if (!metadata_options['Custom Fields']){
                        Enterobase.modalAlert("Please add a custom field before uplaoding a file containing values for this field");
                        return;      
                }
                var i = Enterobase.makeCustomFileInput("fileupload",function(file){  
                        uploadMetadata(file);
                });
                i.trigger("click");
        });
 
        $("#metadata-select").on("change",function(e){
                the_tree.changeCategory($(this).val());
        });
        
        $(window).resize(function(){
                var winh = ($(window).height())-15;
                var winw = ($(window).width());
                var div  = $("#graph-div");
                var sb_width = $("#sidebar").width();
                div.height(winh).css({"max-height":winh+"px","min-height":winh+"px"});
                $("#graph-div").width(winw-sb_width);
        });
        $(window).trigger("resize");
        
       
        $("#mst-save-layout").click(function(e){
                var data = the_tree.getLayout();
                var layout_data =JSON.stringify(data);
                var metadata= the_tree.getMetadata();
                var new_metadata = null;
                
                if (new_metadata_fields.length>0){
                        var new_metadata={};
                        for (var index in metadata){
                                var item = metadata[index];
                                var sid = item['StrainID'];
                                
                                for (var index2 in new_metadata_fields){
                                        if (!new_metadata[sid]){
                                                new_metadata[sid]={};
                                        }
                                        var name = new_metadata_fields[index2];
                                        var value = item[name];
                                        if (value || value ===0){
                                                new_metadata[sid][name]=value;
                                        }
                                }
                        }
                }
                           
                var options = JSON.stringify(metadata_options);
                var to_send = {
                        id:tree_id,
                        layout_data:layout_data,
                        metadata_options:options,
                        current_metadata:$("#metadata-select").val()
                };
                if (new_metadata){
                        to_send.metadata=JSON.stringify(new_metadata);
                }
                
          
        });
        $("#mst-download-svg").click(function(e){
                the_tree.downloadSVG(tree_name);
        });
        
        
        $(".mst-menu-title").click(function(e){
                var id = $(this).attr("id");
                var this_panel =  $("#"+id+"-panel");
                var icon = $("#"+id+"-icon");
                if  (this_panel.hasClass("open-menu-panel")){
                        this_panel.toggle("50");
                        this_panel.removeClass("open-menu-panel");
                        icon.attr("class","glyphicon glyphicon-menu-right"); 
                }
                else{
                        $("#"+id+"-panel").toggle("50");
                        icon.attr("class","glyphicon glyphicon-menu-down"); 
                        $(".open-menu-panel").toggle("50");
                        $(".open-menu-panel").parent().find(".glyphicon").attr("class","glyphicon glyphicon-menu-right"); 
                        $(".open-menu-panel").removeClass("open-menu-panel");
                        $("#"+id+"-panel").addClass("open-menu-panel");
                }
                
        });
        $(".panel-body").hide();
        

     
        $( "#slider-linklength" ).slider({
                orientation: "horizontal",
                min:50,
                max: 10000,
                value: 500,
                slide:function(){the_tree.setLinkLength($("#slider-linklength").slider("value"));},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setLinkLength($("#slider-linklength").slider("value"));
                        }
                }              
        });
        $( "#slider-nodesize" ).slider({
                orientation: "horizontal",
                min:2,
                max: 30,
                value: 10,
                slide:function(){the_tree.setNodeSize($("#slider-nodesize").slider("value"));},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setNodeSize($("#slider-nodesize").slider("value"));
                        }
                }
        });
        $( "#slider-relative-nodesize" ).slider({
                orientation: "horizontal",
                min:0.2,
                max:0.8,
                value: 0.5,
                step:0.02,
                slide:function(){the_tree.setRelativeNodeSize($("#slider-relative-nodesize").slider("value"));},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setRelativeNodeSize($("#slider-relative-nodesize").slider("value"));
                        }
                }
        });
        $( "#slider-node-fontsize" ).slider({
                orientation: "horizontal",
                min:6,
                max: 30,
                value: 12,
                slide:function(){the_tree.setNodeFontSize($("#slider-node-fontsize").slider("value"));},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setNodeFontSize($("#slider-node-fontsize").slider("value"));
                        }
                }
        });
        $( "#slider-linkfontsize" ).slider({
                orientation: "horizontal",
                min:6,
                max: 30,
                value: 14,
                slide:function(){the_tree.setLinkFontSize($("#slider-linkfontsize").slider("value"));},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setLinkFontSize(($("#slider-linkfontsize").slider("value")));
                        }
                }
        });
        
        $( "#slider-charge" ).slider({
                orientation: "horizontal",
                min:0,
                max: 30,
                slide:function(){the_tree.alterCharge($("#slider-charge").slider("value"));},
                change: function(){the_tree.alterCharge($("#slider-charge ").slider("value"));}
        });

        $("#node-label-text").change(function(e){
                var val = $(this).val();
                if (val ==="cat"){
                        val = the_tree.display_category;
                }
                the_tree.setNodeText(val);
        });
        
        $("#spinner-maxlinklength").spinner({
                min:100,
                step:100
        })
        
        $("#spinner-hide-link-length").spinner({
                min:1,
                step:10000
        });
        $("#button-setmaxlinklength").click(function(){
                var max  = $("#spinner-maxlinklength").val();
                if (max){
                        the_tree.setMaxLinkLength(max);
                }	
        });
        $("#button-hide-link-length").click(function(){
                var max  = $("#spinner-hide-link-length").val();
                if (max){
                        the_tree.setHideLinkLength(max);
                }	
        });
        $("#button-refresh").click(function(){	
                waitingDialog =  new Enterobase.ModalWaitingDialog("Updating Graph",null,"/static/js/table/images/waiting.gif");	
                the_tree.refreshGraph(function(){
                        waitingDialog.close();
                        $( "#slider-charge" ).slider("value",3)
                });			
        });
        $("#show-link-labels").click(function(e){			
                the_tree.showLinkLabels($(this).is(":checked"))	
        });
        $("#show-node-labels").click(function(e){
                the_tree.showNodeLabels($(this).is(":checked"));
        });
        $("#show-individual-segments").click(function(e){
                the_tree.showIndividualSegments($(this).is(":checked"));
        });
                
        $("#show-node-tooltip").click(function(e){
                show_node_tooltips = $(this).is(":checked");
        });
                
        $("#link-log-scale").click(function(e){
                the_tree.setLogLinkScale($(this).is(":checked"));
        });
        
        $("#button-load-nwk").click(function(e){
                file_chooser.setFilter(".nwk");
                file_chooser.showOpenDialog(function(files){
                        loadNewickFile(files[0]);
                
                });
        });
        
          $("#button-load-meta").click(function(e){
                file_chooser.setFilter(".txt");
                file_chooser.showOpenDialog(function(files){
                        loadMetadataFile(files[0]);
                });
        });
        
        
        $("#spinner-collapse-nodes").spinner({
                min:1,
                max:100
        });
        
        $("#button-collapse-nodes").click(function(e){
                the_tree.collapseNodes($("#spinner-collapse-nodes").val(),true);
        
        });
        
        $("#save-tree-json").click(function(e){
                var obj= the_tree.getTreeAsObject();
                obj['metadata_options']=metadata_options;
                saveTextAsFile(JSON.stringify(obj));
        
        });
        
        $("#center-graph-button").click(function(e){
             the_tree.centerGraph();
        
        })
        
        
        
  
        
  
};
</script>
</body>
</html>