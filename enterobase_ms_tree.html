<script charset="utf-8" src="/static/js/main/enterobase.js?version={{js_version}}"></script>

<script>
var tree_name="{{tree_name}}";
var database = "{{database}}"
var tree_id = parseInt("{{tree_id}}");
var db_code="{{db_code}}"
var wg_scheme = "{{wg_scheme}}"

 function getRemoteData(){
        Enterobase.call_restful_json("/get_ms_tree_data?id="+tree_id,"GET","",displayErrorMessage).done(function(data){
                if (data['waiting']){
                        setTimeout(function(){
                                getMSTreeData();
                        },10000);
                                
                }
                else if (data['failed']){
                        waitingDialog.setMessage("The tree has failed, please contact an administrator");
                        if (grid_window){
                                grid_window.mst_alert.dialog("close");
                        }
                }
                else{
                        
                        loadMSTree(processEnteroData(data));
                        if (grid_window){
                                     grid_window.mst_alert.dialog("close");
                                }
                        }     
                });      
}

function processEnteroData(data){
          
                /*identifiers are  a list of STs, each list item contains a list of STs 
                * (usually only one long)
                * However multiple STs are possible due to missing data
                */
        var identities=data['data']['identifiers'];
                
        var md = {}
                //ST (The master ST) to strain ids
      
   
        var ST_map={};
        var ST_to_list={}
        var identifiers = [];
        for (var i in identities){
                var list = identities[i];
                if (list.length ===0){
                        identifiers.push("hypothetical_node")       
                }
                else{
                        for (var n in list){
                                if (ST_map[list[n]]){
                                        console.log("Same ST occurring twice:"+list[n]);
                                        continue;
                                }
                                ST_map[list[n]]=list[0];
                        }
                        identifiers.push(list[0]);
                        ST_to_list[list[0]]=list;
                }
        }
        
        //convert list into dictionary 
        var isolates = data['data']['isolates'];
        for (var i in isolates){
                var isolate = isolates[i];
                var node_id  = ST_map[isolate.ID]
                if (!node_id){
                        continue;
                }
                isolate['ID']=node_id;
                md[isolate.StrainID]=isolate;     
        }
        
        
        return {
                initial_category:"Country",//data['data']['current_metadata'],
                layout_data:data['layout'],
                links:data['data']['links'],
                metadata:md,
                metadata_options:data['data']['metadata_options']['Metadata'],
                nodes:identifiers,
                layout_algorithm:"force"
        }
        
        

}

</script>
