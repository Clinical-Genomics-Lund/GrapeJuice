function D3MSTree(e,t,i,s,n){D3BaseTree.call(this,e,t.metadata,s,n)
var o=this
this.tempy=1,this.taxon_key=null,this.charge=0,this.maxChargeDistance=2e3,this.gravity=0,this.original_node_positions={},this.base_font_size=10,this.show_node_labels=!0,this.node_font_size=14,this.link_font_size=10,this.log_link_scale=!1,this.fixed_mode=!0,this.node_radii={},this.previous_node_radii={},this.node_clicked_listeners=[],this.max_link_length=1e4,this.max_link_scale=500,this.hide_link_length=1e4,t.hide_link_length&&(this.hide_link_length=t.hide_link_length),this.show_link_labels=!1,this.distance_scale=d3.scale.linear().domain([0,this.max_link_distance]).range([0,this.max_link_scale]),this.show_individual_segments=!1,this.size_power=.41,this.base_node_size=10,this.update_graphics=!0,this.precompute=!0,this.pie=d3.layout.pie().sort(null).value(function(e){return e.value}),t.initial_category&&(this.display_category=t.initial_category),this.arc=this._calculateArc(),this.d3_force_directed_graph=d3.layout.force(),this.initial_drag_angle=0,this.drag_source=0,this.drag_link=null,this.drag_orig_xy=[0,0],this.force_drag=this.d3_force_directed_graph.drag().on("dragstart",function(e){o._dragStarted(e)}).on("drag",function(e){o._dragging(e)}).on("dragend",function(e){o._dragEnded(e)}),this.add_collapsed_lengths=!0,this.node_collapsed_value=0,this.original_nodes=[],this.original_links=[],this.force_nodes=this.d3_force_directed_graph.nodes(),this.force_links=this.d3_force_directed_graph.links()
var r=null
if(t.nexus||t.nwk){var a=null
if(t.nexus){var l=this.readNexusFile(t.nexus)
this.taxon_key=l.translate,a=l.root}else a=this.parseNewick(t.nwk)
if(this.createLinksFromNewick(a),"force"!==t.layout_algorithm){var d=_traverse(a)
t.layout_data={node_positions:this.greedy_layout(d)}}}else this.original_nodes=t.nodes,this.original_links=t.links
for(var h in this.original_nodes){var _=this.original_nodes[h]
this.grouped_nodes[_]=[_]}var r=null
if(t.layout_data&&(r=t.layout_data.node_positions),t.layout_data&&r)if(this.original_node_positions=r,t.layout_data.nodes_links)var c=this.node_collapsed_value=t.layout_data.nodes_links.node_collapsed_value
else{var c="force"===t.layout_algorithm?0:1e-8
this.node_collapsed_value=0}i&&i(this,"Collapsing Nodes:"+this.original_nodes.length),"force"==t.layout_algorithm&&(c=0),this._collapseNodes(c,r),i&&i(this,"Nodes"+this.force_nodes.length),"force"===t.layout_algorithm||r||t.nwk||t.nexus||(r=this.greedy_layout(this.force_nodes,this.max_link_scale,this.base_node_size),t.layout_data={node_positions:r},this.original_node_positions=r),this.root_node=null
for(var u in this.force_nodes){var f=this.force_nodes[u]
if(!f.parent){this.root_node=f
break}}if((t.nexus||t.nwk)&&"force"!==t.layout_algorithm){var p=this.greedy_layout(this.force_nodes,this.max_link_scale,this.base_node_size)
for(var g in p)t.layout_data.node_positions[g]=p[g]}this._start(i,t.layout_data)}D3MSTree.prototype=Object.create(D3BaseTree.prototype),D3MSTree.prototype.constructor=D3MSTree,D3MSTree.prototype.greedy_layout=function(e,t,i){t=void 0===t?500:t,i=void 0===i?10:i
for(var s in e)node=e[s],node.size||(node.size=1)
var n=0,o=0
for(var s in e)node=e[s],node.length>n&&(n=node.length),o+=node.size
for(var r=Math.sqrt(i),a=n*r/t,o=Math.PI/o,l=0;;){for(var s=e.length-1;s>=0;s--){node=e[s]
var d=[a*Math.sqrt(node.size),o*Math.sqrt(node.size)]
if(node.children&&0!=node.children.length){var h=0,_=0
for(var c in node.children)if(child=node.children[c],child.des_span){if(self_radial=a*Math.sqrt(node.size),Math.cos(Math.PI-child.des_span[1])>child.des_span[0]/(child.length+self_radial)){if(child.des_span[0]<child.length+self_radial)var u=[child.length+self_radial,Math.asin(child.des_span[0]/(child.length+self_radial))]}else{var u=to_Polar(to_Cartesian(child.des_span),[-(child.length+self_radial),0])
u[0]=Math.max(u[0],child.length+self_radial,child.des_span[0])}child.self_span=[u[0],u[1]],_+=u[1]+o,u[0]>h&&(h=u[0])}var f=[h,_]
node.des_span=[Math.max(d[0],f[0]),Math.max(d[1],f[1])],node.des_span[1]>Math.PI&&(node.des_span[1]=Math.PI)}else node.des_span=d}max_span=e[0].des_span[1],e[0].anc_span=[0,0]
for(var s=1;s<e.length;++s){node=e[s],self_radial=a*Math.sqrt(node.size)
for(var h=node.parent.anc_span[0]*node.parent.anc_span[1],_=node.parent.anc_span[1],c=0;c<node.parent.children.length;c++)sister=node.parent.children[c],sister.id!=node.id&&(h+=sister.self_span[0]*sister.self_span[1],_+=sister.self_span[1])
var u=[h/_,_]
if(Math.cos(Math.PI-u[1])>u[0]/(node.length+self_radial))if(u[0]<node.length+self_radial)var p=[node.length+self_radial,Math.sin(u[0]/node.length+self_radial)]
else{var p=to_Polar(to_Cartesian(u),[-(node.length+self_radial),0])
p[0]=u[0]}else{var p=to_Polar(to_Cartesian(u),[-(node.length+self_radial),0])
p[0]<node.length+self_radial&&(p[0]=node.length+self_radial)}node.anc_span=[p[0],p[1]],node.anc_span[1]+node.des_span[1]>max_span&&(max_span=node.anc_span[1]+node.des_span[1])}if(l++,Math.PI>=max_span&&(Math.PI<1.1*max_span||l>10)||l>30)break
o=Math.PI/max_span*o}e[0].polar=[0,0],e[0].coordinates=[0,0],coordinates={},coordinates[e[0].id]=e[0].coordinates
for(var s=0;s<e.length;++s)if(node=e[s],self_radial=a*Math.sqrt(node.size),coordinates[node.id]=node.coordinates,s>0){var g=-node.des_span[1]
if(node.children)for(var c=0;c<node.children.length;++c)child=node.children[c],child.polar=[child.length+self_radial,g+child.self_span[1]+o+node.polar[1]],g+=2*(child.self_span[1]+o),child.coordinates=to_Cartesian(child.polar),child.coordinates[0]+=node.coordinates[0],child.coordinates[1]+=node.coordinates[1]}else for(var v=Math.max(0,(Math.PI-node.des_span[1])/node.children.length),g=0,c=0;c<node.children.length;++c)child=node.children[c],child.polar=[child.length+self_radial,g+child.self_span[1]+o+node.polar[1]],g+=2*(child.self_span[1]+o+v),child.coordinates=to_Cartesian(child.polar),child.coordinates[0]+=node.coordinates[0],child.coordinates[1]+=node.coordinates[1]
return coordinates},_traverse=function(e){nodes=[e]
for(id in e.children)e.children[id].parent=e,nodes=nodes.concat(_traverse(e.children[id]))
return nodes},to_Cartesian=function(e,t){t=void 0===t?[0,0]:t
var i=e[0],s=e[1]
return[i*Math.cos(s)+t[0],i*Math.sin(s)+t[1]]},to_Polar=function(e,t){t=void 0===t?[0,0]:t
var i=e[0]-t[0],s=e[1]-t[1]
return[Math.sqrt(Math.pow(i,2)+Math.pow(s,2)),Math.atan2(s,i)]},D3MSTree.prototype._start=function(e,t){var i=this
this.canvas.selectAll("g.link").remove(),this.link_elements=this.canvas.selectAll("g.link").data(this.force_links,function(e){return e.source.id+"-"+e.target.id}),this.link_elements.enter().append("g").attr("id",function(e){return e.source.id+"-"+e.target.id}).attr("class","link mst-element").append("line").on("click",function(e){i.linkClicked()}).on("mouseover",function(e){i.linkMouseOver(e)}).on("mouseout",function(e){i.linkMouseOut(e)}),this.node_elements=this.canvas.selectAll(".node").data(this.force_nodes,function(e){return e.id}),this.node_elements.exit().remove()
var s=this.node_elements.enter().append("g").attr("class","node mst-element").attr("id",function(e){return e.id})
if(s.append("text").attr("class","link-label").attr("text-anchor","middle").attr("font-size","14px").attr("font-family","sans-serif").style("fill","gray").style("stroke","black").style("stroke-width",".25px").style("opacity",1).text(function(e){return e.id}),s.call(this.force_drag).on("dblclick",function(e){}).on("mouseup",function(e){if(!i.is_dragging){var t=i._getIDsForNode(e.id)
for(var s in i.node_clicked_listeners)i.node_clicked_listeners[s](e,t)}i.is_dragging=!1}),this.node_elements=this.canvas.selectAll(".node"),this.links_to_display=this.link_elements.filter(function(e){return!0}),this.nodes_to_display=this.node_elements.filter(function(e){return!0}),this.d3_force_directed_graph.on("tick",function(){i.update_graphics&&i._updateGraph()}),this.svg.selectAll(".mst-element").sort(function(e,t){return d3.descending(e.value,t.value)}),this.rendering_time=15,t)this.setLayout(t),this._showLinkLabels(),this.changeCategory(this.display_category),this._updateGraph(!0),this.startForce(),this.stopForce(),e&&e(this,"complete")
else{this.charge=-400,this._setLinkDistance(),this.gravity=0,this.svg.style("display","none"),this.startForce()
for(var n in this.force_nodes){var o=this.force_nodes[n]
if(positions){var r=positions[o.id]
o.x=r[0],o.y=r[1]}else o.x=1e3*Math.random(),o.y=1e3*Math.random()}this.update_graphics=!1,e(this,"Calculating Layout"),setTimeout(function(){i._untangleGraph(!0,i.rendering_time,e)},this.rendering_time+1e3)}},D3MSTree.prototype.collapseNodes=function(e){layout=JSON.parse(JSON.stringify(this.original_node_positions)),this._collapseNodes(e,layout),this._start(null,{node_positions:layout,scale:this.scale,translate:this.translate})},D3MSTree.prototype._collapseNodes=function(e,t){if(0===this.node_collapsed_value)for(var i in this.force_nodes){var s=this.force_nodes[i]
t&&(t[s.id]=this.original_node_positions[s.id]=[s.x,s.y])}if(e<=this.node_collapsed_value||!this.force_nodes||0==this.force_nodes.length){this._addNodes(this.original_nodes),this._addLinks(this.original_links,this.original_nodes),this.grouped_nodes={}
for(var i in this.original_nodes){var n=this.original_nodes[i]
this.grouped_nodes[n]=[n]}}var o={},r={}
for(l in this.force_links){var a=this.force_links[l]
o[a.source.id]?o[a.source.id].push(a):o[a.source.id]=[a],a.target.children||(o[a.target.id]=[]),r[a.target.id]=a}this.force_links.sort(function(e,t){return e.value-t.value})
for(var l in this.force_links){var d=this.force_links[l]
if(d.value<=e){d.remove=d.target.remove=!0,d.source.hypothetical||d.target.hypothetical||(this.grouped_nodes[d.source.id]=this.grouped_nodes[d.source.id].concat(this.grouped_nodes[d.target.id]))
var h=d.value
for(var i in d.source.children)if(d.source.children[i].id===d.target.id){d.source.children.splice(i,1)
break}for(var i in d.target.children){var _=d.target.children[i]
d.source.children.push(_),_.parent=d.source}var c=o[d.target.id]
for(var i in c){var u=c[i]
u.remove||(u.source=d.source,d.target.hypothetical&&(u.value+=h,u.original_value=u.value),o[d.source.id].push(u))}if(d.source.hypothetical&&!d.target.hypothetical){if(delete d.source.hypothetical,o[d.source.id]){to_add={}
for(var f in o[d.source.id])u=o[d.source.id][f],u.remove||(to_add[u.target.id]=1)
for(f in to_add)r[f].value+=h
o[d.target.id]=o[d.target.id]?o[d.target.id].concat(o[d.source.id]):o[d.source.id]}r[d.source.id]&&(r[d.source.id].value+=h,r[d.source.id].original_value+=h),r[d.target.id]=r[d.source.id],e>this.node_collapsed_value&&t&&(t[d.target.id]=t[d.source.id]),d.source.id=d.target.id}}}this.node_collapsed_value=e
var p=this.force_nodes.filter(function(e){return!e.remove}),g=this.force_links.filter(function(e){return!e.remove})
this.force_links.length=0
for(var i in g)this.force_links.push(g[i])
this.force_nodes.length=0
for(var i in p){var v=p[i]
this.force_nodes.push(v)}for(var f in this.force_nodes)s=this.force_nodes[f],s.size=this.grouped_nodes[s.id]?this.grouped_nodes[s.id].length:0,r[s.id]&&(s.length=r[s.id].value)
this._updateNodeRadii()},D3MSTree.prototype._getLinksWithSource=function(e,t,i){var s=[]
if(i)for(index in e[t]){var n=e[t][index]
n.remove||n.source.id==i||n.target.id==i||s.push(n)}return s},D3MSTree.prototype._getLinkDistance=function(e,t){for(var i in this.force_links){var s=this.force_links[i]
if(s.source.id==e&&t==s.target.id)return s.value}},D3MSTree.prototype._untangleGraph=function(e,t,i){var s=this
t=t||100,this.startForce(),setTimeout(function(){if(s.charge+=5,s.charge<200&&(s.gravity=0),s.charge>=-3)return s.charge=-3,s.update_graphics=!0,s.startForce(),i(s,"Drawing Tree"),void setTimeout(function(){s.svg.style("display","block"),s._drawNodes(),s.stopForce(),s._fixAllNodes(),e&&s._centerGraph(),s._setLinkDistance()
for(var t in s.force_links)s._correctLinkLengths(s.force_links[t])
for(var t in s.force_nodes){var n=s.force_nodes[t]
s.original_node_positions[n.id]=[n.x,n.y]}s._showLinkLabels(),s._drawLinks(),s.changeCategory(s.display_category),s._updateGraph(!0),i&&i(s,"complete")},10)
i&&i(s,"Refining Layout:"+s.charge/5*-1),s.startForce(),s._untangleGraph(e,t,i)},t)},D3MSTree.prototype.startForce=function(e){var t=this
this.d3_force_directed_graph.gravity(this.gravity).linkDistance(function(e){return e.link_distance}).charge(function(i){return e?i.charge:t.charge}).linkStrength(10).size([this.width,this.height]).start()},D3MSTree.prototype.stopForce=function(){this.d3_force_directed_graph.stop()},D3MSTree.prototype.setLayout=function(e){if(e.node_positions){for(var t in this.force_nodes){var i=this.force_nodes[t],s=e.node_positions[i.id]
i.x=s[0],i.px=s[0],i.y=s[1],i.py=s[1]}this._fixAllNodes()}if(e.nodes_links){var n=e.nodes_links
this.max_link_scale=n.max_link_scale?n.max_link_scale:500,this.size_power=n.size_power?n.size_power:.5,this.base_node_size=n.base_node_size,this.max_link_length=n.max_link_length?n.max_link_length:1e4,this.log_link_scale=n.log_link_scale,this.link_font_size=n.link_font_size?n.link_font_size:this.link_font_size,this.distance_scale=d3.scale.linear().domain([0,this.max_link_distance]).range([0,this.max_link_scale]),this.show_link_labels=n.show_link_labels,this.node_font_size=n.node_font_size?n.node_font_size:this.node_font_size,this.show_individual_segments=n.show_individual_segments,void 0===n.show_node_labels?this.show_node_labels=!0:this.show_node_labels=n.show_node_labels,this.hide_link_length=n.hide_link_length?n.hide_link_length:this.hide_link_length,this.custom_colours=n.custom_colours?n.custom_colours:this.custom_colours,this._updateNodeRadii(),this._setLinkDistance(),this.setLinkLength(this.max_link_scale)}else this.setLinkLength(this.max_link_scale),this.setNodeSize(this.base_node_size)
var o=e.scale?e.scale:1
this.setScale(o)
var r=e.translate?e.translate:[0,0]
this.setTranslate(r),this._drawLinks()},D3MSTree.prototype.getLayout=function(){var e={}
for(var t in this.force_nodes){var i=this.force_nodes[t]
e[i.id]=[i.x,i.y]}for(var i in this.original_node_positions)e[i]||(e[i]=this.original_node_positions[i])
var s={max_link_length:this.max_link_length,max_link_scale:this.max_link_scale,base_node_size:this.base_node_size,size_power:this.size_power,link_font_size:this.link_font_size,show_link_labels:this.show_link_labels,show_node_labels:this.show_node_labels,node_font_size:this.node_font_size,custom_colours:this.custom_colours,hide_link_length:this.hide_link_length,show_individual_segments:this.show_individual_segments,node_collapsed_value:this.node_collapsed_value}
return this.log_link_scale&&(s.log_link_scale="true"),{node_positions:e,nodes_links:s,scale:this.scale,translate:this.translate}},D3MSTree.prototype._drawLinks=function(){var e=this
this.link_elements.selectAll("line").style("stroke",function(t){return t.value>=e.hide_link_length?"white":(t.value,e.max_link_length,"black")}).attr("stroke-dasharray",function(t){return e.max_link_length&&t.value>e.max_link_length?"3,5":""}).attr("stroke-width","3px"),this.link_elements.selectAll(".distance-label").attr("font-size",this.link_font_size)},D3MSTree.prototype.changeCategory=function(e){e?this._changeCategory(e):(this.display_category=null,this.category_colours.missing=this.default_colour)
var t=this
this.node_elements.filter(function(e){return e.hypothetical}).selectAll("circle").data(function(e){return[{cx:e.x,cy:e.y}]}).enter().append("circle").attr("r",3).style("fill","gray")
var i=this.node_elements.filter(function(e){return!e.hypothetical}).selectAll(".node-paths").data(function(i){return t._getPieData(i,e)})
i.enter().append("path").classed("node-paths",!0),i.exit().remove(),this.node_elements.selectAll(".node-paths").on("mouseover",function(e){t.segmentMouseOver(e)}).on("mouseout",function(e){t.segmentMouseOut(e)}).style("stroke","black"),this._drawNodes(),this._setNodeText()},D3MSTree.prototype._drawNodes=function(){var e=this
this.node_elements.selectAll(".node-paths").attr("d",this.arc).attr("fill",function(t){return t.data.node_id?e.default_colour:e.category_colours[t.data.type]}),this.node_elements.selectAll(".halo").attr("d",function(t){var i=e.node_radii[t.id]
return d3.svg.arc().innerRadius(i).outerRadius(i+t.halo_thickness).startAngle(0).endAngle(2*Math.PI)()}).attr("fill",function(e){return e.halo_colour})},D3MSTree.prototype.getTreeAsObject=function(){return{links:this.original_links,nodes:this.original_nodes,layout_data:this.getLayout(),metadata:this.metadata,initial_category:this.display_category}},D3MSTree.prototype._setNodeText=function(){var e=this,t=this.node_text_value
this.node_elements.selectAll("text").remove(),this.show_node_labels&&(node_text=this.node_elements.filter(function(e){return!e.hypothetical}).append("text").attr("class","node-group-number").attr("dy",".71em").attr("text-anchor","middle").attr("font-size",this.node_font_size).attr("font-family","sans-serif").attr("transform",function(t){return"translate(0,"+-e.node_font_size/3+")"}).text(function(i){if(t&&"node_id"!==t){var s=e.metadata_map[i.id]
if(s){var n=e.metadata[s[0]][t]
return n||"ND"}return"ND"}return i.id}))},D3MSTree.prototype._calculateArc=function(){var e=this
return d3.svg.arc().outerRadius(function(t){return e.node_radii[t.data.idx]}).innerRadius(0)},D3MSTree.prototype._getPieData=function(e,t){var i=[]
if(t){var s=this.grouped_nodes[e.id],n=[]
for(var o in s){var r=s[o]
this.metadata_map[r]?n=n.concat(this.metadata_map[r]):n.push("missing")}var a={}
for(o in n)if(strain=n[o],"missing"==strain){var l=a.missing
l?a.missing++:a.missing=1}else{strain_metadata=this.metadata[strain]
var d=strain_metadata[t]
if(d){var h=a[d]
h?a[d]++:a[d]=1}else{var l=a.missing
l?a.missing++:a.missing=1}}for(var _ in a){var h=a[_]
if(this.show_individual_segments)for(var c=0;c<h;c++)i.push({value:1,type:_,idx:e.id})
else i.push({value:h,type:_,idx:e.id})}}else if(this.show_individual_segments){var n=this.grouped_nodes[e.id]
for(var o in n)i.push({value:1,type:"node_name",idx:e.id,node_id:n[o]})}else i=[{value:1,type:"missing",idx:e.id}]
return this.pie(i)},D3MSTree.prototype._updateGraph=function(e){var t=this.links_to_display,i=this.nodes_to_display
e&&(t=this.link_elements,i=this.node_elements),t.selectAll("text").attr("x",function(e){return(e.source.x+e.target.x)/2}).attr("y",function(e){return(e.source.y+e.target.y)/2}),t.selectAll("line").attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),i.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})},D3MSTree.prototype._updateNodeRadii=function(){for(var e in this.force_nodes){node=this.force_nodes[e]
var t=0
if(!node.hypothetical){var i=0,s=this.grouped_nodes[node.id]
for(var n in s){var o=this.metadata_map[s[n]]
o?i+=o.length:i++}t=Math.pow(i,this.size_power)*this.base_node_size}this.node_radii[node.id]=t}},D3MSTree.prototype._saveNodeRadii=function(){for(var e in this.force_nodes){node=this.force_nodes[e]
var t=0
if(!node.hypothetical){var i=0,s=this.grouped_nodes[node.id]
for(var n in s){var o=this.metadata_map[s[n]]
o?i+=o.length:i++}t=Math.pow(i,this.size_power)*this.base_node_size}this.previous_node_radii[node.id]=t}},D3MSTree.prototype._addNodes=function(e){this.force_nodes.length=0,e.length<4&&(this.gravity=.02)
for(var t=0;t<e.length;t++){id=e[t]
var i=id
"hypothetical_node"===id&&(i="_hypo_node_"+t,e[t]=i)
var s={id:i,value:-1,selected:!1}
"hypothetical_node"!==id&&"_hypo_"!==id.substring(0,6)||(s.hypothetical=!0),this.force_nodes.push(s)}},D3MSTree.prototype._findNode=function(e){for(var t in this.force_nodes)if(n=this.force_nodes[t],n.id===e)return n},D3MSTree.prototype.addMetadata=function(e){D3BaseTree.prototype.addMetadata.call(this,e),this.original_nodes&&this.setNodeSize(this.base_node_size)},D3MSTree.prototype._addLinks=function(e,t){this.force_links.length=0
var i=[]
for(var s in e)r=e[s],i.push({value:r.distance,source:t[r.source],target:t[r.target]})
this.max_link_distance=0,this.min_link_distance=1e4
for(var s=0;s<i.length;s++){x=i[s],x.value>this.max_link_distance&&(this.max_link_distance=x.value),x.value<this.min_link_distance&0!==x.value&&(this.min_link_distance=x.value)
var n=this._findNode(x.target),o=this._findNode(x.source),r={source:o,target:n,value:x.value,original_value:x.value}
this.force_links.push(r)}this.distance_scale=d3.scale.linear().domain([0,this.max_link_distance]).range([0,this.max_link_scale])
for(var s in this.force_links){var r=this.force_links[s]
r.source.children||(r.source.children=[]),r.source.children.push(r.target),r.target.parent=r.source}},D3MSTree.prototype._getLink=function(e){for(var t in this.force_links)if(this.force_links[t].target.id===e.id)return this.force_links[t]},D3MSTree.prototype._setLinkDistance=function(e){var t=this
this.link_elements.each(function(i){var s=t.node_radii[i.source.id]+t.node_radii[i.target.id]
e&&(i.value=i.original_value)
var n=i.value
t.max_link_length&&n>t.max_link_length&&(n=t.max_link_length),s=t.log_link_scale?Math.pow(t.distance_scale(n),.8)+s:t.distance_scale(n)+s,i.link_distance=s})},D3MSTree.prototype.refreshGraph=function(e){layout=this.greedy_layout(this.force_nodes,this.max_link_scale,this.base_node_size),this._updateNodeRadii(),this._start(e,{node_positions:layout,scale:this.scale,translate:this.translate})},D3MSTree.prototype._centerGraph=function(){for(var e=this.force_nodes[0],t=e.x,i=e.x,s=e.y,n=e.y,o=this.force_nodes,r=1;r<o.length;r++){var a=o[r]
a.x>t&&(t=a.x),a.x<i&&(i=a.x),a.y>s&&(s=a.y),a.y<n&&(n=a.y)}for(var r=0;r<o.length;r++){var a=o[r]
a.x-=i,a.px=a.x,a.y-=n,a.py=a.y}var l=t-i,d=s-n,h=1
h=l>d?this.width/(t-i):this.height/(s-n),this.setScale(h),this.setTranslate([0,0])},D3MSTree.prototype.centerGraph=function(){this._centerGraph(),this._updateGraph(!0)},D3MSTree.prototype.setLogLinkScale=function(e){this.log_link_scale=e,this._setLinkDistance()
for(var t in this.force_links)this._correctLinkLengths(this.force_links[t])
this._updateGraph(!0)},D3MSTree.prototype.clearSelection=function(){for(var e in this.force_nodes){var t=this.force_nodes[e]
t.selected=!1,delete t.halo_colour,delete t.halo_thickness}this.node_elements.classed("selected",!1),this.node_elements.selectAll(".halo").remove()},D3MSTree.prototype.setMaxLinkLength=function(e){e=parseFloat(e),(isNaN(e)||e<=0)&&(e=null),this.max_link_length=e,this.distance_scale=d3.scale.linear().domain([0,this.max_link_distance]).range([0,this.max_link_scale]).clamp(!0),this._setLinkDistance(),this._drawLinks()
for(var t in this.force_links)this._correctLinkLengths(this.force_links[t])
this._updateGraph(!0)},D3MSTree.prototype.setLinkLength=function(e){if(this.max_link_scale=e,this.distance_scale=d3.scale.linear().domain([0,this.max_link_distance]).range([0,e]),this._setLinkDistance(),this.fixed_mode){this.stopForce()
for(var t in this.force_links)this._correctLinkLengths(this.force_links[t])
this._updateGraph(!0)}},D3MSTree.prototype.setLinkFontSize=function(e){this.link_font_size=e,this.link_elements.selectAll(".distance-label").transition().attr("font-size",this.link_font_size+"px")},D3MSTree.prototype.resetLinkLengths=function(){this._setLinkDistance(!0),this.stopForce()
for(var e in this.force_links){var t=this.force_links[e]
t.value=t.original_value,this._correctLinkLengths(this.force_links[e])}this._updateGraph(!0)},D3MSTree.prototype.showLinkLabels=function(e){this.show_link_labels=e,this._showLinkLabels()},D3MSTree.prototype._showLinkLabels=function(){this.link_elements.selectAll("text").remove(),this.show_link_labels&&(this.link_elements.append("text").attr("class","distance-label").attr("dy",".71em").attr("text-anchor","middle").attr("font-size",this.link_font_size).attr("font-family","sans-serif").style("fill","gray").style("stroke","black").style("stroke-width",".25px").text(function(e){return e.original_value.toPrecision(2)}),this.link_elements.selectAll("text").attr("x",function(e){return(e.source.x+e.target.x)/2}).attr("y",function(e){return(e.source.y+e.target.y)/2}))},D3MSTree.prototype.setNodeSize=function(e){this._saveNodeRadii(),this.base_node_size=e,this._updateNodeRadii(),this._nodeSizeAltered()},D3MSTree.prototype.setRelativeNodeSize=function(e){this._saveNodeRadii(),this.size_power=e,this._updateNodeRadii(),this._nodeSizeAltered()},D3MSTree.prototype._nodeSizeAltered=function(){var e=this
for(var t in this.force_links){var i=this.force_links[t],s=e.previous_node_radii[i.source.id]+e.previous_node_radii[i.target.id],n=e.node_radii[i.source.id]+e.node_radii[i.target.id]
i.link_distance=i.link_distance-s+n}for(var o in this.force_links)this._correctLinkLengths(this.force_links[o])
this._drawNodes(),this._updateGraph(!0)},D3MSTree.prototype.getSelectedIDs=function(){var e=[]
for(i=0;i<this.force_nodes.length;i++){var t=this.force_nodes[i]
t.selected&&(e=e.concat(this._getIDsForNode(t.id)))}ret_list=[]
for(var i in e){var s=e[i]
isNaN(s)||(s=parseInt(s)),ret_list.push(s)}return ret_list},D3MSTree.prototype.showIndividualSegments=function(e){this.show_individual_segments=e,this.changeCategory(this.display_category),this._drawNodes()},D3MSTree.prototype.setNodeFontSize=function(e){this.node_font_size=e,this._setNodeText()},D3MSTree.prototype.setNodeText=function(e){this.node_text_value=e,this._setNodeText()},D3MSTree.prototype.showNodeLabels=function(e){this.show_node_labels=e,this._setNodeText()},D3MSTree.prototype.alterCharge=function(e){this.charge=-1*e,this.startForce()},D3MSTree.prototype._correctLinkLengths=function(e){var t=e.source,i=e.target,s=i.x-t.x,n=i.y-t.y,o=Math.sqrt(s*s+n*n),r=e.link_distance,a=r/o
old_x=i.x,old_y=i.y,i.x=t.x+s*a,i.y=t.y+n*a,i.px=i.x,i.py=i.y,this._alterChildrenPosition(i,i.x-old_x,i.y-old_y)},D3MSTree.prototype._addHalos=function(e,t,i){var s=this,n=d3.svg.arc().innerRadius(30).outerRadius(40).startAngle(0).endAngle(2*Math.PI)
n(),s.node_elements.filter(e).append("path").attr("class","halo").attr("d",function(e){e.halo_thickness=t,e.halo_colour=i
var n=s.node_radii[e.id]
return d3.svg.arc().innerRadius(n).outerRadius(n+t).startAngle(0).endAngle(2*Math.PI)()}).attr("fill",i)
s.node_elements.sort(function(e,t){return e.halo_thickness?1:t.halo_thickness?-1:0})},D3MSTree.prototype._getActualLinkLength=function(e){var t=e.source,i=e.target,s=i.x-t.x,n=i.y-t.y
return Math.sqrt(s*s+n*n)},D3MSTree.prototype._tagAllChildren=function(e,t){if(e.children)for(var i in e.children)child=e.children[i],child.tagged=t,this._tagAllChildren(child,t)},D3MSTree.prototype._updateNodesToDisplay=function(e){e||(e="fixed"),this.links_to_display=this.link_elements.filter(function(t){return t.target[e]||t.source[e]}),this.nodes_to_display=this.node_elements.filter(function(t){return!!t[e]})},D3MSTree.prototype.unfixSelectedNodes=function(e){for(i=0;i<this.force_nodes.length;i++){var t=this.force_nodes[i];(t.selected||e)&&(t.fixed=!1,t.selected=!1,t.update=!0)}e||this._drawNodes(),this._updateNodesToDisplay("update"),this.fixed_mode=!1,this.startForce(!0)},D3MSTree.prototype.fixAllNodes=function(){this.stopForce()
for(var e in this.force_nodes){var t=this.force_nodes[e]
t.fixed=!0,t.update=!1}for(var i in this.force_links){var s=this.force_links[i],n=this._getActualLinkLength(s)
s.link_distance=n
var o=n-this.node_radii[s.source.id]-this.node_radii[s.target.id]
s.value=this.distance_scale.invert(o)}this.fixed_mode=!0,this._updateGraph(!0)},D3MSTree.prototype._fixAllNodes=function(){for(var e in this.force_nodes)node=this.force_nodes[e],node.fixed=!0,node.charge=-30
this.links_to_display=this.link_elements.filter(function(e){return!1}),this.nodes_to_display=this.node_elements.filter(function(e){return!1}),this.node_elements.classed("fixed",!0)},D3MSTree.prototype._alterChildrenPosition=function(e,t,i){if(e.children)for(var s in e.children)child=e.children[s],child.x+=t,child.y+=i,child.px=child.x,child.py=child.y,this._alterChildrenPosition(child,t,i)},D3MSTree.prototype._rotateChildren=function(e,t,i){if(e.children)for(var s in e.children){child=e.children[s]
var n=child.x-i.x,o=child.y-i.y,r=Math.sqrt(n*n+o*o),a=Math.atan2(o,n),l=a+t
x_offset=Math.cos(l)*r,y_offset=Math.sin(l)*r,child.x=i.x+x_offset,child.y=i.y+y_offset,child.px=child.x,child.py=child.y,this._rotateChildren(child,t,i)}},D3MSTree.prototype.setHideLinkLength=function(e){this.hide_link_length=e,this._drawLinks()},D3MSTree.prototype._unfixAllChildNodes=function(e,t){if(e.children&&4!==t)if(t)t++
else for(var i in e.children)child=e.children[i],child.fixed=!1,child.charge=0,this.unfixAllChildNodes(child,t)},D3MSTree.prototype._getIDsForNode=function(e){var t=[],i=this.grouped_nodes[e]
for(var s in i){var n=this.metadata_map[i[s]]
n?t=t.concat(n):t.push(i[s])}return t},D3MSTree.prototype.highlightIDs=function(e){this.clearSelection()
var t=this
this._addHalos(function(i){for(var s=t.getIDsForNode(i.id),n=0;n<e.length;n++)if(-1!==s.indexOf(e[n]))return!0
return!1},22,"yellow")},D3MSTree.prototype._dragStarted=function(e){if(this.fixed_mode){if(this.stopForce(),!e.parent)return void(this.drag_orig_xy=[e.x,e.y])
e.fixed=!0,e.tagged=!0,this._tagAllChildren(e,!0),this.node_elements.filter(function(e){return e.tagged}).selectAll(".node-paths").style("stroke","red").attr("stroke-width","3px"),this._updateNodesToDisplay("tagged"),this.drag_link=this._getLink(e)
var t=e.x-e.parent.x,i=e.y-e.parent.y
this.drag_source=e.parent,this.initial_drag_angle=Math.atan2(i,t),this.drag_radius=Math.sqrt(t*t+i*i)}},D3MSTree.prototype._dragging=function(e){if(this.is_dragging=!0,this.fixed_mode){if(!e.parent)return e.x=this.drag_orig_xy[0],e.y=this.drag_orig_xy[1],e.px=e.x,void(e.py=e.y)
e.px+=d3.event.dx,e.py+=d3.event.dy,e.x+=d3.event.dx,e.y+=d3.event.dy
var t=this.drag_source,i=e,s=i.x-t.x,n=i.y-t.y,o=Math.sqrt(s*s+n*n),r=this.drag_link.link_distance,a=r/o
old_x=i.x,old_y=i.y,i.x=t.x+s*a,i.y=t.y+n*a,i.px=i.x,i.py=i.y
var l=Math.atan2(e.y-t.y,e.x-t.x),d=l-this.initial_drag_angle
this._rotateChildren(e,d,this.drag_source),this.initial_drag_angle=Math.atan2(n,s),this._updateGraph()}},D3MSTree.prototype._dragEnded=function(e){if(this.fixed_mode&&e.parent){var t=this.drag_source,i=e,s=i.x-t.x,n=i.y-t.y,o=Math.sqrt(s*s+n*n),r=this.drag_radius,a=r/o
i.x=t.x+s*a,i.y=t.y+n*a,i.px=i.x,i.py=i.y
var l=Math.atan2(e.y-t.y,e.x-t.x),d=l-this.initial_drag_angle
this.node_elements.filter(function(e){return e.tagged}).selectAll(".node-paths").style("stroke","black").attr("stroke-width","1px"),e.fixed=!0,e.tagged=!1,this._rotateChildren(e,d,t),this._updateGraph(),this._tagAllChildren(e,!1),this.stopForce()}},D3MSTree.prototype.createLinksFromNewick=function(e,t){if(e.children)this.original_nodes.push("_hypo_node_"+this.original_nodes.length),e.id="_hypo_node_"+(this.original_nodes.length-1)
else{var i=e.name
this.taxon_key&&((i=this.taxon_key[e.name])||(i=e.name)),this.original_nodes.push(i),e.id=i}var s=this.original_nodes.length-1
if(0!=s&&this.original_links.push({source:t,target:s,distance:e.length}),e.children)for(var n in e.children){var o=e.children[n]
this.createLinksFromNewick(o,s)}},D3MSTree.prototype.createLinksFromNewick2=function(e){for(var t in e){var i=e[t]
if(i.children)this.original_nodes.push("_hypo_node_"+t),i.name="_hypo_node_"+t
else{var s=i.name
this.taxon_key&&((s=this.taxon_key[i.name])||(s=i.name)),this.original_nodes.push(s+"")}i.parent&&this.original_links.push({source:i.parent,target:i.id,distance:i.edge_length})}},D3MSTree.prototype.addNodeClickedListener=function(e){this.node_clicked_listeners.push(e)},D3MSTree.prototype.brushEnded=function(e){this.node_elements.filter(function(t){var i=e[0][0]<=t.x&&t.x<e[1][0]&&e[0][1]<=t.y&&t.y<e[1][1]
return i&&(t.selected=!0),i}).classed("selected","true"),this._addHalos(function(e){return e.selected},5,"red")}
